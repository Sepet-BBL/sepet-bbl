<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBL - SepetSepetHisse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Chakra+Petch:wght@400;700&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <style>
        :root { --jersey-primary: #2563eb; --jersey-secondary: #1e3a8a; --logo-color: #ffffff; --jersey-pattern: none; }
        
        /* --- TEMEL AYARLAR (MOBÄ°L UYUMLU) --- */
        body { 
            background-color: #020617; 
            font-family: 'Inter', sans-serif; 
            color: white; 
            width: 100vw; 
            display: flex; 
            flex-direction: column; 
            overflow-x: hidden; 
            overflow-y: auto; 
            height: auto; 
            min-width: 0; 
        }
        
        ::-webkit-scrollbar { width: 5px; height: 5px; } ::-webkit-scrollbar-track { background: #0f172a; } ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        /* NAVBAR */
        nav { background: #0f172a; border-bottom: 1px solid #1e293b; display: flex; flex-wrap: wrap; align-items: center; padding: 10px; gap: 10px; z-index: 50; box-sizing: border-box; }
        
        .nav-brand { display: flex; align-items: center; gap: 10px; min-width: auto; flex-shrink: 0; }
        .brand-logo-container { width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; }
        .brand-logo-img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 5px rgba(59,130,246,0.5)); }
        .brand-fallback { width: 34px; height: 34px; background: #2563eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 11px; color: white; border: 2px solid white; box-shadow: 0 0 10px #2563eb; }
        .brand-text-col { display: flex; flex-direction: column; justify-content: center; }
        .brand-title { font-family: 'Chakra Petch', sans-serif; font-weight: 900; font-size: 16px; line-height: 1; letter-spacing: 0.5px; white-space: nowrap; }
        .brand-subtitle { font-size: 9px; font-weight: bold; letter-spacing: 2px; color: #22c55e; margin-top: 1px; white-space: nowrap; }
        .text-orange-bbl { color: #f97316; text-shadow: 0 0 10px rgba(249, 115, 22, 0.4); } 
        .text-blue-bbl { color: #3b82f6; text-shadow: 0 0 10px rgba(59, 130, 246, 0.4); }

        .nav-center-group { display: flex; align-items: center; gap: 25px; flex: 1; justify-content: center; padding: 5px 10px; width: 100%; order: 3; border-top: 1px solid #1e293b; margin-top: 5px; }
        .nav-budget { display: flex; flex-direction: column; width: 200px; justify-content: center; flex-shrink: 0; }
        .budget-track { width: 100%; height: 6px; background: #1e293b; border-radius: 3px; overflow: hidden; border: 1px solid #334155; margin-top: 2px; position: relative; }
        .budget-fill { height: 100%; background: #3b82f6; width: 0%; transition: width 0.5s ease; box-shadow: 0 0 10px rgba(59,130,246,0.5); }
        .budget-warning { background: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }

        .transfer-info-box { font-size: 10px; color: #94a3b8; display: flex; gap: 8px; align-items: center; justify-content: center; margin-top: 2px; position: relative; cursor: help; white-space: nowrap; min-width: 250px; }
        .info-text { color: #fbbf24; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-pill { background: #1e293b; padding: 1px 5px; border-radius: 3px; border: 1px solid #334155; white-space: nowrap; font-weight: bold; font-family: monospace; font-size: 9px; }
        .info-pill.warning { border-color: #ef4444; color: #fca5a5; background: #450a0a; }
        .info-pill.success { border-color: #22c55e; color: #86efac; background: #064e3b; }
        
        .transfer-tooltip { position: absolute; top: 100%; left: 50%; transform: translateX(-50%); margin-top: 10px; background: rgba(2, 6, 23, 0.98); border: 1px solid #3b82f6; color: #e2e8f0; padding: 12px; border-radius: 8px; font-size: 11px; width: 280px; text-align: left; opacity: 0; pointer-events: none; transition: 0.2s; z-index: 9999; box-shadow: 0 10px 30px rgba(0,0,0,1); }
        .transfer-info-box:hover .transfer-tooltip, .group:hover .transfer-tooltip { opacity: 1; }
        .transfer-tooltip ul { list-style: none; padding: 0; margin: 5px 0 0 0; }
        .transfer-tooltip li { margin-bottom: 4px; padding-left: 10px; border-left: 2px solid #334155; }

        .nav-right-group { display: flex; gap: 10px; items-center; min-width: auto; justify-content: flex-end; flex: 1; }

        /* LAYOUT */
        #layout-grid { display: flex; flex-direction: column; overflow: visible; height: auto; position: relative; }
        
        /* Sol Panel (Market) */
        .left-panel { background: #0f172a; border-bottom: 1px solid #1e293b; display: flex; flex-direction: column; overflow: hidden; z-index: 20; width: 100%; height: 400px; flex-shrink: 0; order: 2; }
        
        /* Tab TasarÄ±mÄ± */
        .tab-group { display: flex; width: 100%; border-bottom: 1px solid #1e293b; background: #020617; }
        .tab-btn { flex: 1; padding: 8px; text-align: center; font-size: 10px; font-weight: 900; color: #64748b; cursor: pointer; transition: 0.2s; border-bottom: 2px solid transparent; }
        .tab-btn:hover { color: #cbd5e1; background: #0f172a; }
        .tab-btn.active-tab { color: #3b82f6; border-bottom-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }

        .market-header { height: auto; padding: 0; display: flex; flex-direction: column; background: #0f172a; flex-shrink: 0; }
        
        .search-input { width: 100%; background: #020617; border: 1px solid #334155; border-radius: 6px; padding: 6px 8px 6px 28px; font-size: 11px; color: white; outline: none; transition: 0.2s; }
        .search-input::placeholder { color: #64748b; }
        .search-input.filtered { border-color: #3b82f6; background: rgba(59,130,246,0.1); color: #60a5fa; font-weight: bold; }
        .icon-btn { width: 32px; height: 32px; border-radius: 6px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; border: 1px solid #334155; position: relative; color: #94a3b8; }
        .icon-btn:hover { transform: translateY(-2px); filter: brightness(1.2); color: white; border-color: #64748b; }
        .icon-btn.active-filter { border-color: #3b82f6; color: #3b82f6; background: rgba(59,130,246,0.1); }
        .filter-close-badge { position: absolute; top: -5px; right: -5px; width: 14px; height: 14px; background: #ef4444; color: white; border-radius: 50%; border: 1px solid #0f172a; font-size: 9px; display: none; align-items: center; justify-content: center; z-index: 10; }
        .icon-btn.active-filter .filter-close-badge { display: flex; }

        .market-list { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .market-item { display: flex; flex-direction: column; justify-content: center; padding: 8px 12px; border-bottom: 1px solid #1e293b; cursor: grab; background: #0f172a; transition: 0.2s; min-height: 75px; position: relative; overflow: hidden; }
        .market-item:hover { background: #172554; border-left: 3px solid #3b82f6; z-index: 10; overflow: visible; }
        .market-item.used { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        .market-item.dragging { opacity: 0.5; background: #1e293b; }
        
        .cond-strip { position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: #334155; }
        .cond-fill { width: 100%; position: absolute; bottom: 0; transition: height 0.5s ease; }
        .cond-high { background: #22c55e; } .cond-med { background: #eab308; } .cond-low { background: #ef4444; }
        
        /* Logo & Favori - BÃœYÃœTÃœLMÃœÅž LOGO */
        .market-logo-container { width: 40px; height: 40px; margin-right: 12px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: #0f172a; border-radius: 6px; border: 1px solid #334155; }
        .market-logo-img { width: 90%; height: 90%; object-fit: contain; }
        .market-logo-fallback { width: 100%; height: 100%; background: #334155; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; color: #cbd5e1; }

        .fav-btn { position: absolute; right: 10px; top: 10px; color: #334155; cursor: pointer; z-index: 20; transition: 0.2s; font-size: 14px; }
        .fav-btn:hover { color: #f43f5e; transform: scale(1.2); }
        .fav-btn.is-fav { color: #f43f5e; text-shadow: 0 0 10px rgba(244, 63, 94, 0.5); }

        .m-row-1 { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .m-name-group { display: flex; align-items: center; flex: 1; min-width: 0; overflow: hidden; }
        .m-name { font-size: 15px; font-weight: 900; color: white; letter-spacing: 0.5px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 0; margin-right: 6px; }
        
        .contract-badge { font-size: 9px; font-weight: 900; padding: 1px 5px; border-radius: 3px; text-transform: uppercase; border: 1px solid rgba(255,255,255,0.2); display: inline-flex; align-items: center; flex-shrink: 0; cursor: help; }
        .c-elit { background: linear-gradient(to right, #78350f, #92400e); color: #fcd34d; border-color: #f59e0b; }
        .c-std { background: #1e3a8a; color: #bfdbfe; border-color: #3b82f6; }
        .c-yari { background: #3f3f46; color: #a1a1aa; border-color: #52525b; }
        .fame-icon { font-size: 12px; margin-left: 2px; cursor: help; filter: drop-shadow(0 0 2px rgba(255,255,255,0.5)); flex-shrink: 0; }
        .trait-mini { font-size: 10px; padding: 0 2px; cursor: help; }
        
        .m-cost-box { text-align: right; min-width: 50px; position: relative; flex-shrink: 0; cursor: help; }
        .m-price { font-size: 16px; font-weight: 900; color: #facc15; font-family: monospace; text-shadow: 0 0 10px rgba(250, 204, 21, 0.4); }
        .m-cost-box:hover::after { content: attr(data-breakdown); position: absolute; right: 100%; top: 50%; transform: translateY(-50%); background: rgba(15, 23, 42, 0.98); color: #fff; padding: 6px 10px; border-radius: 4px; border: 1px solid #fbbf24; font-size: 10px; white-space: nowrap; z-index: 100; margin-right: 8px; pointer-events: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }

        .m-row-2 { display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 5px; margin-top: 2px; }
        .m-traits-wrapper { display: flex; gap: 3px; overflow: hidden; flex-wrap: nowrap; align-items: center; flex: 1; }
        .skill-icon-mini { font-size: 10px; padding: 1px 4px; border-radius: 2px; cursor: help; font-weight: bold; border: 1px solid; display: flex; align-items: center; justify-content: center; }
        .sk-def { background: #064e3b; color: #6ee7b7; border-color: #10b981; }
        .sk-sut { background: #450a0a; color: #fca5a5; border-color: #ef4444; }
        .sk-hiz { background: #172554; color: #bfdbfe; border-color: #3b82f6; }
        .sk-guc { background: #4c1d95; color: #d8b4fe; border-color: #8b5cf6; } 
        .sk-tek { background: #713f12; color: #fcd34d; border-color: #f59e0b; } 
        .m-basic-stats { display: flex; gap: 8px; font-family: monospace; font-size: 10px; color: #94a3b8; font-weight: bold; margin-left: auto; white-space: nowrap; }
        .hl-val { color: #38bdf8; }

        .m-expanded { display: none; margin-top: 8px; padding-top: 6px; border-top: 1px solid #1e3a8a; background: #0f172a; animation: slideDown 0.2s ease-out; }
        .market-item:hover .m-expanded { display: block; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .comparison-table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 2px; }
        .comparison-table th { padding: 3px; font-weight: bold; border-bottom: 1px solid #334155; }
        .comparison-table td { padding: 3px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .diamond-icon { font-size: 10px; margin-left: 3px; animation: pulse 2s infinite; }
        
        .perf-table-row { display: flex; justify-content: space-between; font-size: 9px; padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .perf-val-up { color: #4ade80; font-weight: bold; }
        .perf-val-down { color: #f87171; font-weight: bold; }
        .perf-val-neutral { color: #94a3b8; }

        /* CENTER STAGE */
        .center-stage { display: flex; flex-direction: column; height: auto; min-height: 500px; padding: 10px; background: linear-gradient(to bottom, #0f172a, #020617); position: relative; z-index: 10; width: 100%; order: 1; }
        .court-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; gap: 10px; min-height: 0; }
        .court-surface { width: 100%; max-width: 100%; aspect-ratio: 1.5/1; position: relative; background: #1e293b; border: 8px solid #1e293b; border-radius: 12px; box-shadow: inset 0 0 150px rgba(0,0,0,0.8); overflow: hidden; display: flex; justify-content: center; align-items: center; z-index: 10; }
        .svg-court { width: 100%; height: 100%; display: block; object-fit: fill; opacity: 0.9; }
        .court-sponsor-text { position: absolute; top: 75%; left: 50%; transform: translate(-50%, -50%); font-family: 'Black Ops One', cursive; font-size: 45px; color: rgba(255,255,255,0.15); pointer-events: none; z-index: 1; letter-spacing: 5px; text-align: center; line-height: 1.1; white-space: pre-line; }

        /* BILLBOARDS */
        .side-billboard { width: 60px; height: 90%; flex-shrink: 0; background: #0f172a; border: 1px solid #334155; border-radius: 4px; display: none; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(0,0,0,0.8); overflow: hidden; position: relative; cursor: pointer; transition: transform 0.2s; }
        .side-billboard:hover { transform: scale(1.02); border-color: #fbbf24; }
        .billboard-img { width: 100%; height: 100%; object-fit: cover; }
        .billboard-fallback { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); font-weight: 900; letter-spacing: 4px; color: #64748b; font-size: 12px; white-space: nowrap; opacity: 0.5; }

        /* BOTTOM PANEL */
        .bottom-panel { height: auto; margin-top: 15px; flex-shrink: 0; display: flex; flex-direction: column; gap: 10px; align-items: center; z-index: 30; position: relative; }
        .bench-container-outer { width: 100%; display: flex; justify-content: flex-start; overflow-x: auto; padding-bottom: 5px; }
        .bench-wrapper { min-width: 550px; background: #1e293b; border-top: 4px solid #334155; border-radius: 12px; padding: 15px; display: flex; gap: 10px; justify-content: center; align-items: center; box-shadow: inset 0 10px 30px rgba(0,0,0,0.6); height: 100%; }
        .bench-seat { width: 100px; height: 110px; background: linear-gradient(to bottom, #2563eb, #172554); border-radius: 12px 12px 6px 6px; border-bottom: 6px solid #0f172a; display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 5px 10px rgba(0,0,0,0.5), inset 0 2px 5px rgba(255,255,255,0.1); border-left: 2px solid rgba(255,255,255,0.05); border-right: 2px solid rgba(255,255,255,0.05); }
        .bench-seat::before { content: ''; position: absolute; top: 5px; left: 10px; right: 10px; height: 40px; background: rgba(0,0,0,0.2); border-radius: 8px; pointer-events: none; }

        .control-group { width: 100%; height: 50px; display: flex; flex-direction: row; gap: 4px; justify-content: center; position: relative; }
        .icon-only-btn { flex: 1; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); background: #1e293b; color: #cbd5e1; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; position: relative; overflow: visible; font-size: 14px; }
        .icon-only-btn:hover { background: #334155; color: white; border-color: #64748b; transform: scale(1.05); }
        .btn-atk.active { border-color: #ef4444; color: #fca5a5; background: #450a0a; }
        .btn-def.active { border-color: #22c55e; color: #86efac; background: #052e16; }
        .btn-bal.active { border-color: #3b82f6; color: #bfdbfe; background: #172554; }
        .btn-prim-active { border-color: #f59e0b !important; color: #fcd34d !important; background: #451a03 !important; box-shadow: 0 0 10px rgba(245,158,11,0.3); }
        .icon-only-btn .cap-badge { position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 10px; color: #facc15; border-radius: 8px; backdrop-filter: blur(2px); overflow: hidden; pointer-events: none; }
        .coach-tooltip { position: fixed; bottom: 180px; left: 50%; transform: translateX(-50%); width: 220px; background: rgba(0,0,0,0.98); border: 1px solid #fbbf24; color: #e2e8f0; padding: 12px; border-radius: 8px; font-size: 11px; opacity: 0; pointer-events: none; transition: all 0.2s; z-index: 100000; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,1); }
        .coach-tooltip strong { color: #facc15; font-size: 12px; display: block; margin-bottom: 4px; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 4px; }
        .icon-only-btn:hover .coach-tooltip { opacity: 1; }

        /* CARDS */
        .slot-container { position: absolute; transform: translate(-50%, -50%); width: 120px; height: 160px; z-index: 50; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .slot-container > * { pointer-events: auto; }
        .player-card { width: 110px; height: 160px; position: relative; cursor: grab; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; transition: transform 0.2s; }
        .player-card:hover { transform: scale(1.1); z-index: 1000; }
        .player-card:active { transform: scale(0.95); cursor: grabbing; }
        .player-head { width: 60px; height: 60px; background: white; border-radius: 50%; border: 3px solid #fff; position: absolute; top: -20px; z-index: 30; object-fit: contain; padding: 2px; box-shadow: 0 4px 10px rgba(0,0,0,0.4); background-size: cover; background-position: center; }
        .player-perf-badge { position: absolute; top: -25px; right: 0px; background: #020617; border: 1px solid; border-radius: 4px; padding: 1px 4px; font-size: 9px; font-weight: bold; z-index: 40; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .perf-pos { border-color: #22c55e; color: #4ade80; } .perf-neg { border-color: #ef4444; color: #fca5a5; }

        .jersey { width: 100%; height: 125px; background-color: var(--jersey-primary); border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; display: flex; flex-direction: column; align-items: center; position: relative; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.6); padding-top: 25px; }
        .jersey::before { content: ''; position: absolute; inset: 0; pointer-events: none; z-index: 1; background-image: radial-gradient(rgba(0,0,0,0.15) 1px, transparent 1px); background-size: 4px 4px; opacity: 0.6; }
        .jersey.pattern-plain { background: var(--jersey-primary); }
        .jersey.pattern-vertical { background: linear-gradient(90deg, var(--jersey-primary) 50%, var(--jersey-secondary) 50%); background-size: 20px 100%; }
        .jersey.pattern-horizontal { background: linear-gradient(180deg, var(--jersey-primary) 50%, var(--jersey-secondary) 50%); background-size: 100% 100%; }
        .jersey.pattern-sash { background: linear-gradient(135deg, var(--jersey-primary) 40%, var(--jersey-secondary) 40%, var(--jersey-secondary) 60%, var(--jersey-primary) 60%); }
        .jersey.pattern-hoops { background: repeating-linear-gradient(45deg, var(--jersey-primary), var(--jersey-primary) 10px, var(--jersey-secondary) 10px, var(--jersey-secondary) 20px); }

        .jersey-sponsor-area { width: 100%; height: 35px; display: flex; align-items: center; justify-content: center; background: transparent; margin-top: 2px; z-index: 10; }
        .jersey-bottom { width: 100%; display: flex; flex-direction: column; align-items: center; margin-top: auto; z-index: 10; padding-bottom: 5px; }
        .jersey-name { color: #fbbf24; font-size: 12px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; width: 100%; text-align: center; padding: 2px 0; }
        .jersey-name.has-bg { background: rgba(0,0,0,0.6); }

        .traits-container { display: flex; gap: 3px; margin-bottom: 3px; z-index: 20; justify-content: center; width: 100%; }
        .trait-icon-card { width: 18px; height: 18px; background: rgba(15,23,42,0.8); border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; display: flex; justify-content: center; align-items: center; font-size: 11px; color: #fbbf24; box-shadow: 0 1px 2px rgba(0,0,0,0.5); cursor: help; }

        .shoulder-badge { position: absolute; top: 40px; left: -10px; padding: 2px 5px; border-radius: 4px; font-size: 9px; font-weight: 900; color: white; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.6); transform: rotate(-5deg); border: 1px solid rgba(255,255,255,0.3); cursor: help; }
        .shoulder-badge:hover { z-index: 200 !important; }
        .shoulder-badge:hover::after { content: attr(data-traits); position: absolute; left: 100%; top: 0; background: rgba(15, 23, 42, 0.98); color: #fbbf24; padding: 8px; border-radius: 6px; font-size: 10px; white-space: pre; z-index: 1000; border: 1px solid #fbbf24; margin-left: 5px; box-shadow: 0 4px 15px rgba(0,0,0,0.9); text-align: left; line-height: 1.5; min-width: 120px; }
        .sb-elit { background: linear-gradient(to right, #b45309, #d97706); } .sb-std { background: #1e3a8a; } .sb-yari { background: #3f3f46; }

        .cost-badge { position: absolute; top: -5px; right: -5px; width: 24px; height: 24px; background: #facc15; border: 2px solid white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 900; font-size: 10px; color: black; z-index: 60; cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.4); transition: all 0.2s; }
        .cost-badge:hover { background: #ef4444; color: white; transform: scale(1.1); }
        .cost-badge .remove-icon { display: none; }
        .cost-badge:hover .val-text { display: none; }
        .cost-badge:hover .remove-icon { display: block; font-size: 12px; }

        .loan-badge { position: absolute; top: -5px; left: -5px; width: 24px; height: 24px; background: #3b82f6; border: 2px solid white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 900; font-size: 10px; color: white; z-index: 60; cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.4); transition: all 0.2s; }
        .loan-badge:hover { transform: scale(1.1); }
        .loan-active { background: #8b5cf6 !important; border-color: #fcd34d !important; }

        .armband { position: absolute; top: 40px; right: -12px; padding: 2px 6px; font-size: 9px; font-weight: 900; color: white; transform: rotate(-10deg); border: 1px solid white; z-index: 55; box-shadow: 0 2px 5px rgba(0,0,0,0.5); pointer-events: none; }
        .band-c { background: linear-gradient(to right, #f59e0b, #b45309); }
        .band-vc { background: linear-gradient(to right, #94a3b8, #475569); }
        .loan-icon { position: absolute; top: -5px; left: -5px; width: 24px; height: 24px; background: #8b5cf6; border: 2px solid white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 900; font-size: 10px; color: white; z-index: 60; box-shadow: 0 3px 6px rgba(0,0,0,0.4); }
        .empty-slot-circle { width: 60px; height: 60px; border-radius: 50%; border: 2px dashed #64748b; display: flex; align-items: center; justify-content: center; color: #64748b; font-weight: bold; font-size: 14px; background: rgba(15, 23, 42, 0.5); pointer-events: auto; }

        /* RIGHT PANEL */
        .right-panel { background: #0f172a; border-left: none; border-top: 1px solid #1e293b; padding: 15px; display: flex; flex-direction: column; z-index: 20; gap: 15px; width: 100%; order: 3; }
        .scoreboard-panel { background: #000; border: 4px solid #333; border-radius: 8px; padding: 15px; box-shadow: 0 0 25px rgba(0,0,0,0.9); font-family: 'Chakra Petch', sans-serif; position: relative; overflow: hidden; min-height: 120px; display: flex; flex-direction: column; }
        .score-header { display: flex; justify-content: space-between; align-items: center; color: #888; font-size: 11px; font-weight: bold; letter-spacing: 1px; margin-bottom: 10px; }
        .live-indicator { color: #ef4444; text-shadow: 0 0 5px red; animation: pulse 2s infinite; font-size: 10px; }
        .mola-indicator { color: #3b82f6; text-shadow: 0 0 5px #3b82f6; animation: pulse 3s infinite; font-size: 10px; }
        .score-main { display: flex; justify-content: space-between; align-items: center; flex: 1; }
        .team-score { text-align: center; width: 40%; }
        .team-name { color: #fff; font-size: 14px; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
        .score-val { color: #facc15; font-size: 36px; font-weight: 900; letter-spacing: 2px; font-family: 'Black Ops One', cursive; line-height: 1; }
        .period-info-container { display: flex; flex-direction: column; align-items: center; justify-content: center; background: #222; border: 1px solid #444; border-radius: 4px; padding: 5px 10px; }
        .period-title { color: #ef4444; font-size: 10px; font-weight: 900; letter-spacing: 1px; margin-bottom: 2px; }
        .period-numbers { display: flex; gap: 4px; font-size: 10px; color: #555; font-family: monospace; font-weight: bold; }
        .p-num.active { color: #facc15; text-shadow: 0 0 5px #facc15; }

        .league-section { flex: 1; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #1e293b; border-radius: 8px; background: #0f172a; cursor: pointer; transition: 0.2s; min-height: 200px; }
        .league-section:hover { border-color: #3b82f6; }
        .league-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #1e293b; border-bottom: 1px solid #334155; }
        .league-title { font-size: 12px; font-weight: 900; color: #cbd5e1; text-transform: uppercase; }
        .league-tag { font-size: 9px; padding: 2px 6px; border-radius: 3px; font-weight: bold; border: 1px solid; }
        .tag-cup { background: #7c2d12; color: #fdba74; border-color: #fb923c; }
        .tag-league { background: #1e3a8a; color: #bfdbfe; border-color: #3b82f6; }
        .standings-table { width: 100%; border-collapse: separate; border-spacing: 0 4px; }
        .standings-row td { padding: 8px 6px; font-size: 11px; }
        .rank-cell { font-weight: 900; width: 30px; text-align: center; color: #94a3b8; }
        .points-cell { text-align: right; font-family: monospace; font-weight: 700; color: #cbd5e1; }
        .user-highlight { background: #1e3a8a !important; border-radius: 4px; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #0f172a; border: 1px solid #334155; width: 600px; max-height: 90vh; border-radius: 12px; display: flex; flex-direction: column; max-width: 95vw; }
        .modal-header { padding: 15px; border-bottom: 1px solid #1e293b; display: flex; justify-content: space-between; font-weight: bold; color: white; background: #1e293b; border-radius: 12px 12px 0 0; }
        .modal-body { padding: 15px; overflow-y: auto; color: #cbd5e1; font-size: 12px; }
        .filter-group { margin-bottom: 15px; }
        .filter-title { font-weight: bold; color: #94a3b8; margin-bottom: 5px; display: block; font-size: 10px; text-transform: uppercase; }
        .filter-select { width: 100%; background: #020617; border: 1px solid #334155; color: white; padding: 8px; border-radius: 4px; font-size: 11px; }
        .toast { position: fixed; bottom: 50px; right: 30px; background: #1e293b; color: white; padding: 12px; border-radius: 8px; opacity: 0; transition: 0.3s; z-index: 10000; border: 1px solid #3b82f6; }
        .toast.show { transform: translateY(0); opacity: 1; }
        #error-overlay { position: fixed; top: 0; left: 0; width: 100%; background: #ef4444; color: white; padding: 20px; z-index: 999999; text-align: center; font-weight: bold; display: none; }

        /* LÄ°G MODAL */
        .league-modal-content { width: 95vw; height: 90vh; background: #020617; }
        .league-grid-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: #334155; height: 100%; overflow-x: auto; }
        .league-col { background: #0f172a; display: flex; flex-direction: column; overflow: hidden; min-width: 200px; }
        .league-col-header { padding: 10px; text-align: center; font-weight: 900; font-size: 12px; border-bottom: 1px solid #1e293b; color: white; }
        .col-promo .league-col-header { background: #064e3b; color: #86efac; }
        .col-relegate .league-col-header { background: #450a0a; color: #fca5a5; }
        .full-standings-list { overflow-y: auto; flex: 1; padding: 5px; }
        .full-row { display: flex; justify-content: space-between; padding: 6px 8px; font-size: 11px; border-bottom: 1px solid #1e293b; color: #94a3b8; }
        .full-row:last-child { border-bottom: none; }
        .full-row.me { background: #172554; color: white; font-weight: bold; }
        
        /* FRIENDS */
        .friend-row { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #1e293b; cursor: pointer; transition: 0.2s; }
        .friend-row:hover { background: #1e293b; }
        .friend-info { display: flex; flex-direction: column; }
        .friend-name { font-weight: bold; color: white; }
        .friend-status { font-size: 10px; color: #94a3b8; }
        .friend-rank { font-weight: bold; font-family: monospace; color: #facc15; }
        
        /* SETTINGS MODAL */
        .settings-content { width: 600px; max-height: 90vh; background: #0f172a; border: 1px solid #334155; border-radius: 12px; display: flex; flex-direction: column; }
        .logo-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .logo-option { aspect-ratio: 1/1; background: #1e293b; border: 1px solid #334155; border-radius: 6px; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 18px; color: #94a3b8; transition: 0.2s; }
        .logo-option:hover { border-color: #3b82f6; color: white; background: #334155; }
        .logo-option.selected { background: #2563eb; color: white; border-color: #60a5fa; box-shadow: 0 0 10px rgba(37,99,235,0.5); }

        /* HISTORY MODAL (FIXED ROW HEIGHT) */
        .history-wrapper { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .history-season-col { width: 220px; min-width: 220px; display: flex; flex-direction: column; gap: 6px; border: 1px solid #334155; border-radius: 6px; background: #0f172a; overflow: hidden; flex-shrink: 0; }
        .history-season-header { background: #1e3a8a; color: white; padding: 6px; font-weight: 900; font-size: 11px; letter-spacing: 0.5px; text-align: center; border-bottom: 1px solid #1e293b; }
        .history-month-block { border-bottom: 1px solid #334155; }
        .history-month-block:last-child { border-bottom: none; }
        .history-month-header { background: #1e293b; padding: 4px 6px; font-size: 9px; font-weight: bold; color: #94a3b8; display: flex; justify-content: space-between; align-items: center; }
        .history-week-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 3px 6px; 
            font-size: 9px; 
            color: #cbd5e1; 
            border-top: 1px solid rgba(255,255,255,0.05);
            white-space: nowrap; /* Tek satÄ±ra zorla */
            align-items: center;
        }
        .history-score { font-family: monospace; font-weight: bold; color: #facc15; }
        .history-rank-badge { padding: 1px 4px; border-radius: 3px; font-size: 8px; font-weight: bold; border: 1px solid; }
        .rank-green { background: #064e3b; color: #86efac; border-color: #10b981; }
        .rank-red { background: #450a0a; color: #fca5a5; border-color: #ef4444; }
        .rank-mid { background: #334155; color: #cbd5e1; border-color: #64748b; }

        /* --- MASAÃœSTÃœ Ä°Ã‡Ä°N DÃœZEN (1024px ve Ã¼zeri) --- */
        @media (min-width: 1024px) {
            body { height: 100vh; display: grid; grid-template-rows: 60px 1fr; overflow: hidden; }
            nav { flex-wrap: nowrap; height: 60px; gap: 0; padding: 0 15px; }
            .nav-center-group { order: 0; width: auto; border: none; margin: 0; flex: 1; padding: 0 10px; }
            #layout-grid { display: grid; grid-template-columns: 340px 1fr 300px; height: 100%; overflow: hidden; }
            .left-panel { width: 340px; height: 100%; border-right: 1px solid #1e293b; border-bottom: none; order: 0; }
            .center-stage { height: 100%; padding: 20px; order: 0; }
            .court-wrapper { flex-direction: row; }
            .side-billboard { display: flex; }
            .bottom-panel { display: grid; grid-template-columns: 60px 1fr 60px; height: 160px; gap: 15px; }
            .bench-container-outer { overflow: visible; justify-content: center; }
            .bench-wrapper { min-width: auto; }
            .control-group { flex-direction: column; height: 100%; }
            .right-panel { width: auto; height: 100%; border-left: 1px solid #1e293b; border-top: none; order: 0; }
        }
    </style>
</head>
<body>

    <div id="error-overlay"></div>
    <div id="toast" class="toast"></div>

    <nav>
        <div class="nav-brand">
            <div class="brand-logo-container">
                <img src="assets/icon.png" class="brand-logo-img" onerror="this.style.display='none'; document.getElementById('default-brand').style.display='flex'">
                <div id="default-brand" class="brand-fallback" style="display:none">BBL</div>
            </div>
            <div class="brand-text-col">
                <div class="brand-title"><span class="text-orange-bbl">BORSA</span> <span class="text-blue-bbl">BASKETBOL</span> <span class="text-white">LÄ°GÄ°</span></div>
                <div class="brand-subtitle">SEZON AÃ‡IK</div>
            </div>
        </div>
        
        <div class="nav-center-group">
            <div class="nav-budget">
                <div class="flex justify-between text-[10px] text-slate-400 mb-1"><span>TAKIM BÃœTÃ‡ESÄ°</span><span id="budget-text" class="text-white">0 / 140M</span></div>
                <div class="budget-track"><div id="budget-bar" class="budget-fill"></div></div>
            </div>
            <div class="transfer-info-box">
                <span id="gameweek-info" class="info-text"></span>
                <span id="transfer-count-badge" class="info-pill">Transfer: 0/1</span>
                <span id="loan-count-badge" class="info-pill">KiralÄ±k: 0/1</span>
                
                <div class="transfer-tooltip">
                    <strong class="text-yellow-500 border-b border-white/10 pb-1 block mb-1">TRANSFER KURALLARI</strong>
                    <ul>
                        <li><span class="text-green-400">Lig BaÅŸÄ± (Mar,Haz,Eyl,Ara):</span> 5 Transfer</li>
                        <li><span class="text-blue-400">Kupa BaÅŸÄ± (DiÄŸer Aylar):</span> 3 Transfer</li>
                        <li><span class="text-slate-400">Normal Hafta:</span> 1 Transfer</li>
                        <li class="mt-2 text-[10px] text-slate-500 italic">*Yeni Ã¼yeler iÃ§in ilk hafta sÄ±nÄ±rsÄ±z.</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="nav-right-group">
             <button onclick="openModal('performance-modal')" class="text-slate-400 hover:text-white mr-1" title="GeÃ§miÅŸ Performans"><i class="fas fa-history"></i></button>
             <button onclick="openFriendsModal()" class="text-slate-400 hover:text-white mr-2" title="ArkadaÅŸlar"><i class="fas fa-users"></i></button>
             
             <button id="reset-btn" onclick="resetSquad()" class="bg-red-900/50 hover:bg-red-800 text-red-200 border border-red-800 px-3 py-2 rounded text-xs font-bold transition">KADROYU SIFIRLA</button>
             <button id="save-btn" onclick="save()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-xs font-bold transition">KAYDET</button>
             
             <button id="auth-btn" class="border border-slate-600 text-slate-400 px-3 py-2 rounded text-xs hover:text-white" onclick="login()">GÄ°RÄ°Åž</button>
             <div id="nav-team-logo" onclick="openSettings()" title="TakÄ±m Merkezi"><i class="fas fa-basketball text-white"></i></div>
        </div>
    </nav>

    <div id="layout-grid">
        <aside class="left-panel">
            <div class="market-header" style="flex-direction: column; height: auto; padding: 0; gap:0;">
                <div class="flex items-center w-full p-2 gap-2 border-b border-slate-800">
                    <div class="search-box relative w-full">
                        <i class="fas fa-search absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
                        <input type="text" id="search-input" class="search-input" placeholder="Hisse Ara..." onkeyup="renderMarket()">
                    </div>
                    <div class="icon-btn btn-president" onclick="window.showToast('ðŸš§ Bu Ã¶zellik yapÄ±m aÅŸamasÄ±ndadÄ±r...', 'bg-slate-600')" title="BaÅŸkanÄ±n Talepleri">
                        <i class="fas fa-user-tie text-sm"></i><div id="pres-badge" class="notification-dot"></div>
                    </div>
                    <div id="btn-scout" class="icon-btn" onclick="openModal('scout-modal')" title="Scout Filtreleme">
                        <i class="fas fa-binoculars text-sm"></i>
                        <div class="filter-close-badge" onclick="event.stopPropagation(); resetFilters();">X</div>
                    </div>
                </div>
                
                <div class="tab-group">
                    <div id="tab-all" class="tab-btn active-tab" onclick="switchMarketTab('all')">TÃœM PÄ°YASA</div>
                    <div id="tab-fav" class="tab-btn" onclick="switchMarketTab('fav')"><i class="fas fa-heart mr-1"></i>HAVUZUM</div>
                </div>
            </div>
            
            <div id="market-list" class="market-list"></div>
        </aside>

        <main class="center-stage">
            <div class="court-wrapper">
                <a href="#" target="_blank" class="side-billboard left" id="ad-left">
                    <img src="assets/pano.gif" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'" class="billboard-img">
                    <div class="billboard-fallback">REKLAM VER</div>
                </a>
                
                <div class="court-surface" id="court-drop-zone">
                      <div class="court-sponsor-text">SPONSOR<br>ARENA</div>
                      <svg class="svg-court" viewBox="0 0 1000 640" preserveAspectRatio="none">
                        <defs><pattern id="woodPattern" width="40" height="200" patternUnits="userSpaceOnUse" patternTransform="rotate(90)"><rect width="40" height="200" fill="#d4a373"/><line x1="0" y1="0" x2="0" y2="200" stroke="#c08d5d" stroke-width="1.5"/><line x1="0" y1="50" x2="40" y2="50" stroke="#c08d5d" stroke-width="1" stroke-opacity="0.3"/></pattern><pattern id="darkWoodPattern" width="40" height="200" patternUnits="userSpaceOnUse" patternTransform="rotate(90)"><rect width="40" height="200" fill="#b07d4d"/><line x1="0" y1="0" x2="0" y2="200" stroke="#8c5e3c" stroke-width="1.5"/></pattern></defs>
                        <rect width="100%" height="100%" fill="url(#woodPattern)" />
                        <rect width="100%" height="100%" fill="rgba(0,0,0,0.1)" />
                        <rect x="380" y="0" width="240" height="380" fill="url(#darkWoodPattern)" stroke="white" stroke-width="4" stroke-opacity="0.8"/>
                        <g stroke="#ffffff" stroke-width="6" fill="none" opacity="0.85">
                            <path d="M 50,0 V 100 Q 50,550 500,550 Q 950,550 950,100 V 0" fill="none"/><circle cx="500" cy="380" r="70" stroke-dasharray="15,15" /><path d="M 430,380 A 70,70 0 0,1 570,380" fill="none"/><path d="M 460,55 A 40,40 0 0,1 540,55" /><line x1="450" y1="30" x2="550" y2="30" stroke="#1e293b" stroke-width="8" /><circle cx="500" cy="65" r="15" stroke="#ea580c" stroke-width="5" />
                        </g>
                        <rect width="100%" height="100%" fill="url(#woodPattern)" fill-opacity="0" style="box-shadow: inset 0 0 100px black;" />
                      </svg>
                </div>

                <a href="#" target="_blank" class="side-billboard right" id="ad-right">
                    <img src="assets/pano.gif" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'" class="billboard-img">
                    <div class="billboard-fallback">REKLAM VER</div>
                </a>
            </div>

            <div class="bottom-panel">
                <div class="control-group">
                    <div class="icon-only-btn btn-atk" onclick="setTactic('atak')" onmouseover="showTooltip(this, 'âš”ï¸ ATAK', 'Risk: YÃ¼ksek<br>Endeks > %2 Beklenir')" onmouseout="hideTooltip()"><i class="fas fa-meteor"></i></div>
                    <div class="icon-only-btn btn-def" onclick="setTactic('defans')" onmouseover="showTooltip(this, 'ðŸ›¡ï¸ DEFANS', 'Risk: DÃ¼ÅŸÃ¼k<br>Endeks < -%1 Beklenir')" onmouseout="hideTooltip()"><i class="fas fa-shield-alt"></i></div>
                    <div class="icon-only-btn btn-bal active" onclick="setTactic('dengeli')" onmouseover="showTooltip(this, 'âš–ï¸ DENGELÄ°', 'Risk: Orta<br>Standart Puan')" onmouseout="hideTooltip()"><i class="fas fa-balance-scale"></i></div>
                    <div class="icon-only-btn btn-prim" onclick="toggleBonus()" onmouseover="showTooltip(this, 'ðŸ’° PRÄ°M (TOGGLE)', 'Ayda 1 Kez.<br>TÃ¼m Puan x1.5')" onmouseout="hideTooltip()"><i class="fas fa-coins text-yellow-500"></i></div>
                </div>
                <div class="bench-container-outer"><div class="bench-wrapper" id="bench-container"></div></div>
                <div class="control-group">
                    <div id="btn-cap" class="icon-only-btn" onclick="openCaptainSelector('C')" onmouseover="showTooltip(this, 'KAPTAN', 'SeÃ§ilen Hisse<br>Etkisi x1.5')" onmouseout="hideTooltip()"><i class="fas fa-copyright text-yellow-500"></i></div>
                    <div id="btn-vc" class="icon-only-btn" onclick="openCaptainSelector('VC')" onmouseover="showTooltip(this, 'YRD. KAPTAN', 'SeÃ§ilen Hisse<br>Etkisi x1.25')" onmouseout="hideTooltip()"><i class="fas fa-star-half-alt text-gray-400"></i></div>
                    <div id="btn-loan" class="icon-only-btn" onclick="openLoanSelector()" onmouseover="showTooltip(this, 'KÄ°RALIK', 'Etkisi x1.10<br>MaaÅŸ: 5M')" onmouseout="hideTooltip()"><i class="fas fa-suitcase text-purple-400"></i></div>
                </div>
            </div>
        </main>

        <aside class="right-panel">
            <div class="scoreboard-panel">
                <div class="score-header"><span>SPONSOR ARENA</span><span id="match-status" class="live-indicator">OYNANIYOR</span></div>
                <div class="score-main">
                    <div class="team-score"><div class="team-name" id="scoreboard-team-name">SEN</div><div class="score-val text-yellow-400" id="score-val-user">0</div></div>
                    <div class="period-info-container"><div class="period-title">PERÄ°YOT</div><div class="period-numbers"><span class="p-num active">1</span><span class="p-num">2</span><span class="p-num">3</span><span class="p-num">4</span><span class="p-num">Ext</span></div></div>
                    <div class="team-score"><div class="team-name">BIST</div><div class="score-val text-red-500" id="score-val-opponent">0</div></div>
                </div>
            </div>
            
            <button onclick="simulateMatch()" class="bg-indigo-900 border border-indigo-500 text-indigo-100 hover:bg-indigo-800 text-xs font-bold py-2 px-4 rounded mb-2 w-full">MAÃ‡I SÄ°MÃœLE ET (TEST)</button>

            <div class="league-section" onclick="openLeagueModal('KUPA')">
                <div class="league-header"><div class="league-title">15. BBL KUPASI</div><span class="league-tag tag-cup">KUPA</span></div>
                <div class="bg-slate-900 rounded-lg border border-slate-800 overflow-y-auto flex-1 p-3">
                    <table class="standings-table" id="mini-table-cup"></table>
                </div>
            </div>
            <div class="league-section" style="border:none;" onclick="openLeagueModal('LIG')">
                <div class="league-header"><div class="league-title">30. BBL LÄ°GÄ°</div><span class="league-tag tag-league">LÄ°G</span></div>
                <div class="bg-slate-900 rounded-lg border border-slate-800 overflow-y-auto flex-1 p-3">
                    <table class="standings-table" id="mini-table-league"></table>
                </div>
            </div>
        </aside>
    </div>

    <div id="president-modal" class="modal-overlay" style="display:none;"><div class="modal-box"><div class="modal-header"><span>BAÅžKANIN TALEPLERÄ°</span><button onclick="closeModal('president-modal')">X</button></div><div class="modal-body"><div class="bg-slate-900 p-3 rounded border border-slate-700 mb-4 flex gap-3"><img src="https://ui-avatars.com/api/?name=Baskan&background=312e81&color=fff" class="w-10 h-10 rounded-full"><div><div class="font-bold text-yellow-500 text-sm">HaftalÄ±k GÃ¶rev</div><p id="president-quest-text" class="text-xs mt-1">...</p></div></div></div></div></div>

    <div id="scout-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span>SCOUT FÄ°LTRELEME</span><button onclick="closeModal('scout-modal')">X</button></div>
            <div class="modal-body">
                <div class="filter-group"><span class="filter-title">TEMEL KRÄ°TERLER</span><div class="flex flex-col gap-2"><select id="filter-sector" class="filter-select"><option value="all">TÃ¼m SektÃ¶rler</option></select><select id="filter-contract" class="filter-select"><option value="all">TÃ¼m SÃ¶zleÅŸme Tipleri</option><option value="ELÄ°T">ELÄ°T (YÄ±ldÄ±z Pazar)</option><option value="STND">STND (Ana Pazar)</option><option value="YARI">YARI (DiÄŸer)</option></select><select id="filter-fame" class="filter-select"><option value="all">TÃ¼m ÅžÃ¶hret Seviyeleri</option><option value="30">UluslararasÄ± (BIST 30)</option><option value="50">BÃ¶lgesel (BIST 50)</option><option value="100">Ulusal (BIST 100)</option></select></div></div>
                
                <div class="filter-group"><span class="filter-title">Ã–ZEL YETENEKLER</span><div class="grid grid-cols-2 gap-2 text-xs">
                    <label class="flex items-center gap-2"><input type="checkbox" id="chk-skill-pot"> Potansiyel (Analist GÃ¶rÃ¼ÅŸÃ¼)</label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="chk-skill-zek"> Zeka (Beneish GÃ¼venilir)</label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="chk-skill-def"> Defans (Altman GÃ¼venli)</label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="chk-skill-asist"> Asist (TemettÃ¼ Verimi)</label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="chk-skill-sut"> Åžut (Ã–zkaynak Getirisi)</label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="chk-skill-hiz"> HÄ±z (FAVÃ–K BÃ¼yÃ¼me)</label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="chk-skill-guc"> GÃ¼Ã§ (KÃ¢r MarjÄ±)</label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="chk-skill-tek"> Teknik (Ar-Ge)</label>
                </div></div>

                <div class="filter-group"><span class="filter-title">SEKTÃ–RÃœNE GÃ–RE UCUZ</span><div class="grid grid-cols-3 gap-2 text-xs"><label class="flex items-center gap-1 text-[10px]"><input type="checkbox" id="chk-ucuz-fk"> F/K</label><label class="flex items-center gap-1 text-[10px]"><input type="checkbox" id="chk-ucuz-pd"> PD/DD</label><label class="flex items-center gap-1 text-[10px]"><input type="checkbox" id="chk-ucuz-fd"> FD/FAVÃ–K</label></div></div>
                <div class="filter-group mt-3 border-t border-slate-700 pt-2"><span class="filter-title">DÄ°ÄžER Ã–ZELLÄ°KLER</span><div class="grid grid-cols-2 gap-2 text-xs"><label class="flex items-center gap-2"><input type="checkbox" id="chk-temettu"> TemettÃ¼</label><label class="flex items-center gap-2"><input type="checkbox" id="chk-temettu25"> TemettÃ¼ 25</label><label class="flex items-center gap-2"><input type="checkbox" id="chk-katilim"> KatÄ±lÄ±m</label><label class="flex items-center gap-2"><input type="checkbox" id="chk-katilim100"> KatÄ±lÄ±m 100</label><label class="flex items-center gap-2"><input type="checkbox" id="chk-gerialim"> Geri AlÄ±m</label><label class="flex items-center gap-2"><input type="checkbox" id="chk-kurumsal"> Kurumsal</label><label class="flex items-center gap-2"><input type="checkbox" id="chk-halkaarz"> Halka Arz</label><label class="flex items-center gap-2"><input type="checkbox" id="chk-surdurulebilir"> SÃ¼rdÃ¼rÃ¼lebilir</label></div></div>
                <button onclick="applyDetailedFilters()" class="w-full py-2 bg-blue-600 hover:bg-blue-500 rounded text-xs font-bold mt-2">UYGULA</button>
                <button onclick="resetFilters()" class="w-full py-2 bg-slate-700 hover:bg-slate-600 rounded text-xs font-bold mt-2">FÄ°LTRELERÄ° TEMÄ°ZLE</button>
            </div>
        </div>
    </div>

    <div id="performance-modal" class="modal-overlay"><div class="modal-box" style="width: 950px; max-width: 98vw;"><div class="modal-header"><span>GEÃ‡MÄ°Åž PERFORMANS</span><button onclick="closeModal('performance-modal')">X</button></div><div class="modal-body" id="history-container"></div></div></div>

    <div id="friends-modal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><span>ARKADAÅž LÄ°STESÄ°</span><button onclick="closeModal('friends-modal')">X</button></div><div class="modal-body"><div class="flex gap-2 mb-4"><input type="text" class="search-input" placeholder="ArkadaÅŸ Kodu Gir... (#U-xxxx)"><button onclick="addFriend()" class="bg-blue-600 px-3 rounded text-white text-xs font-bold hover:bg-blue-500">EKLE</button></div><div class="flex flex-col gap-2"></div></div></div></div></div>
    <div id="squad-view-modal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><span id="friend-squad-title">KADRO</span><button onclick="closeModal('squad-view-modal')">X</button></div><div class="modal-body text-center p-5"><div class="text-sm mb-3 text-slate-400">HAFTANIN Ä°LK 5'Ä°</div><div class="flex justify-center gap-2" id="friend-squad-list"></div></div></div></div>
    
    <div id="league-modal" class="modal-overlay"><div class="modal-box league-modal-content"><div class="modal-header"><span id="league-modal-title">LÄ°G TABLOSU</span><button onclick="closeModal('league-modal')">X</button></div><div class="league-grid-container"><div class="league-col col-promo"><div class="league-col-header">YÃœKSELME (1-25)</div><div class="full-standings-list" id="list-col-1"></div></div><div class="league-col"><div class="league-col-header">26-50</div><div class="full-standings-list" id="list-col-2"></div></div><div class="league-col"><div class="league-col-header">51-75</div><div class="full-standings-list" id="list-col-3"></div></div><div class="league-col col-relegate"><div class="league-col-header">DÃœÅžME (76-100)</div><div class="full-standings-list" id="list-col-4"></div></div></div></div></div>

    <div id="captain-modal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><span id="cap-modal-title">KAPTAN SEÃ‡</span><button onclick="closeModal('captain-modal')">X</button></div><div class="p-3 bg-slate-900 border-b border-slate-700 text-xs text-yellow-500 text-center"><i class="fas fa-info-circle mr-1"></i> Kaptan Kupa boyunca deÄŸiÅŸmez. Yrd. Kaptan her hafta deÄŸiÅŸebilir.</div><div class="modal-body" id="captain-list"></div></div></div>
    <div id="loan-modal" class="modal-overlay"><div class="modal-box"><div class="modal-header"><span>KÄ°RALIK OYUNCU SEÃ‡ (MAAÅž: 5M)</span><button onclick="closeModal('loan-modal')">X</button></div><div class="modal-body" id="loan-list"><div class="text-center text-slate-500 py-4">Bu hafta yeni transfer edilen oyuncu yok.</div></div></div></div>
    
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content settings-content">
            <div class="modal-header"><span>TAKIM MERKEZÄ°</span><button onclick="closeSettings()">X</button></div>
            <div class="modal-body" style="padding: 20px; overflow-y: auto;">
                <div class="bg-slate-900 p-3 rounded mb-6 text-center border border-slate-700">
                    <span class="text-xs text-slate-400 block mb-1">ARKADAÅž KODUNUZ</span>
                    <span class="text-xl font-mono font-bold text-yellow-500 tracking-widest select-all" id="user-friend-code">#U-0000</span>
                </div>
                
                <div class="flex gap-6 mb-6">
                    <div class="w-1/3 flex flex-col items-center">
                        <label class="form-label text-center mb-2">CANLI Ã–NÄ°ZLEME</label>
                        <div id="preview-jersey" class="jersey" style="width: 120px; height: 140px;">
                            <div class="jersey-sponsor-area"><i id="preview-icon" class="fas fa-basketball opacity-50 text-3xl"></i></div>
                            <div class="jersey-bottom"><span id="preview-name" class="jersey-name has-bg text-sm">SEN</span></div>
                        </div>
                    </div>
                    
                    <div class="w-2/3 flex flex-col gap-3">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">TAKIM Ä°SMÄ°</label>
                            <input type="text" id="team-name-input" class="w-full bg-slate-900 border border-slate-700 text-white p-2 rounded text-xs" value="SEN" oninput="updateModalPreview()">
                        </div>
                        <div class="flex items-center justify-between bg-slate-800 p-2 rounded border border-slate-700">
                            <span class="text-[10px] font-bold text-slate-400">Ä°SÄ°M ARKAPLANI</span>
                            <input type="checkbox" id="text-bg-check" checked onchange="updateModalPreview()">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">FORMA DESENÄ°</label>
                            <select id="jersey-pattern" class="w-full bg-slate-900 border border-slate-700 text-white p-2 rounded text-xs" onchange="updateModalPreview()">
                                <option value="pattern-plain">DÃ¼z Renk</option>
                                <option value="pattern-vertical">Dikey Ã‡izgili</option>
                                <option value="pattern-horizontal">Yatay Ã‡izgili</option>
                                <option value="pattern-sash">Ã‡apraz KuÅŸak</option>
                                <option value="pattern-hoops">Baklava</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-3 mb-4">
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">FORMA RENGÄ° (ANA)</label><div id="palette-primary" class="color-palette"></div></div>
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">FORMA RENGÄ° (Ä°KÄ°NCÄ°L)</label><div id="palette-secondary" class="color-palette"></div></div>
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">LOGO RENGÄ°</label><div id="palette-logo" class="color-palette"></div></div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">TAKIM LOGOSU</label>
                    <div class="logo-grid" id="logo-selector">
                         <div class="logo-option selected" onclick="selectLogoPreview(this, 'fa-basketball')"><i class="fas fa-basketball"></i></div>
                         <div class="logo-option" onclick="selectLogoPreview(this, 'fa-dragon')"><i class="fas fa-dragon"></i></div>
                         <div class="logo-option" onclick="selectLogoPreview(this, 'fa-shield-cat')"><i class="fas fa-shield-cat"></i></div>
                         <div class="logo-option" onclick="selectLogoPreview(this, 'fa-bolt')"><i class="fas fa-bolt"></i></div>
                         <div class="logo-option" onclick="selectLogoPreview(this, 'fa-fire')"><i class="fas fa-fire"></i></div>
                         <div class="logo-option" onclick="selectLogoPreview(this, 'fa-crown')"><i class="fas fa-crown"></i></div>
                         <div class="logo-option" onclick="selectLogoPreview(this, 'fa-gem')"><i class="fas fa-gem"></i></div>
                         <div class="logo-option" onclick="selectLogoPreview(this, 'fa-ghost')"><i class="fas fa-ghost"></i></div>
                         <div class="logo-option" onclick="selectLogoPreview(this, 'fa-rocket')"><i class="fas fa-rocket"></i></div>
                         <div class="logo-option" onclick="selectLogoPreview(this, 'fa-paw')"><i class="fas fa-paw"></i></div>
                         <div class="logo-option" onclick="selectLogoPreview(this, 'fa-anchor')"><i class="fas fa-anchor"></i></div>
                         <div class="logo-option" onclick="selectLogoPreview(this, 'fa-atom')"><i class="fas fa-atom"></i></div>
                    </div>
                </div>

                <button onclick="saveSettings()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition mt-6">DEÄžÄ°ÅžÄ°KLÄ°KLERÄ° KAYDET</button>
            </div>
        </div>
    </div>

    <script>
        // --- REKLAM LÄ°NKLERÄ° ---
        const AD_LINKS = { left: "https://www.google.com", right: "https://www.youtube.com" };
        document.getElementById('ad-left').href = AD_LINKS.left;
        document.getElementById('ad-right').href = AD_LINKS.right;

        const firebaseConfig = {
            apiKey: "AIzaSyAkDCmDQA8rwIdW0DBZUZXCRDls3cOhUwE",
            authDomain: "sepet-bbl.firebaseapp.com",
            projectId: "sepet-bbl",
            storageBucket: "sepet-bbl.firebasestorage.app",
            messagingSenderId: "99119850868",
            appId: "1:99119850868:web:613540a6df362e0d1a3821",
            measurementId: "G-NW6GY0Z19G"
        };
        const appId = "sepet-bbl";
        const COLLECTION_NAME = "sepet";

        let db, auth, user;
        let isFetching = false;
        window.LIVE_STOCKS = {}; 
        window.SECTOR_LIST = new Set();
        window.SECTOR_STATS = {}; 
        window.SKILL_MEDIANS = {};
        window.ACTIVE_FILTERS = null;
        
        window.GAME_STATE = { 
            captain: null, 
            viceCaptain: null, 
            loanPlayer: null, 
            tactic: 'dengeli', 
            currentQuest: null, 
            initialSquad: [], 
            marketOpen: true, 
            transferLimit: 1, 
            loanLimit: 1, 
            bonusUsed: false,
            watchlist: [], // ARRAY YAPILDI (SIRALAMA Ä°Ã‡Ä°N)
            activeTab: 'all' 
        };
        let pool = { court: [null,null,null,null,null], bench: [null,null,null,null,null] };
        
        let appState = { name: "SEN", primary: "#2563eb", secondary: "#1e3a8a", logoColor: "#ffffff", pattern: "pattern-plain", icon: "fa-basketball", textBg: true };
        let tempState = { ...appState };
        
        // SÄ°MÃœLASYON Ä°Ã‡Ä°N BIST DEÄžERÄ°
        let SIMULATED_BIST_CHANGE = 2.5; 

        const PRESET_COLORS = ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', '#d946ef', '#f43f5e', '#ffffff', '#94a3b8', '#475569', '#1e293b', '#000000', '#14532d', '#713f12', '#831843', '#4c1d95'];
        let MAX_BUDGET = 140; 

        const QUESTS = [{ id: 1, text: "PortfÃ¶yÃ¼nde en az 1 adet BIST 30 (UluslararasÄ±) oyuncusu bulundur." }, { id: 2, text: "Yedek kulÃ¼besini tamamen doldur." }];
        // DATA MAP GUNCELLENDI
        const DATA_MAP = { COL_FULL_NAME: 'hakkinda', COL_PD_DD: 'pddd', COL_FK: 'fk', COL_FD_FAVOK: 'fdfavok', COL_SECTOR: 'sektor', COL_SECTOR_CODE: 'sektor_kodu', COL_INDEX: 'endeks', COL_MARKET: 'pazar', COL_SCORE: 'temel_puan', COL_CORP: 'kurumsal', COL_DIVIDEND_INFO: 'temettu_bilgi', COL_BUYBACK: 'gerialim', COL_PARTICIPATION: 'katilim', COL_IPO: 'halkaarz', COL_SURDUR: 'surdurulebilir', COL_TRANSFER: 'transfer_degeri' };
        
        const SECTOR_MAP = { 'XELKT': { i: 'âš¡', name: 'ELEKTRÄ°K' }, 'XTAST': { i: 'ðŸ§±', name: 'TAÅž TOPRAK' }, 'XGIDA': { i: 'ðŸ”', name: 'GIDA' }, 'XBANK': { i: 'ðŸ¦', name: 'BANKA' }, 'XKMYA': { i: 'âš—ï¸', name: 'KÄ°MYA' }, 'XU100': { i: 'ðŸ¢', name: 'BIST 100' }, 'XU030': { i: 'ðŸš€', name: 'BIST 30' }, 'XMANA': { i: 'ðŸ—ï¸', name: 'METAL ANA' }, 'XUTEK': { i: 'ðŸ’»', name: 'TEKNOLOJÄ°' }, 'XILET': { i: 'ðŸ“¡', name: 'Ä°LETÄ°ÅžÄ°M' }, 'XKAGT': { i: 'ðŸŒ²', name: 'ORMAN KAÄžIT' }, 'XGMYO': { i: 'ðŸ˜ï¸', name: 'GAYRÄ°MENKUL' }, 'XTEKS': { i: 'ðŸ‘•', name: 'TEKSTÄ°L' }, 'XTCRT': { i: 'ðŸ›ï¸', name: 'TÄ°CARET' }, 'XULAS': { i: 'âœˆï¸', name: 'ULAÅžTIRMA' }, 'XSPOR': { i: 'âš½', name: 'SPOR' }, 'XZK': { i: 'ðŸ¨', name: 'TURÄ°ZM' }, 'XBILISIM': { i: 'ðŸ’»', name: 'BÄ°LÄ°ÅžÄ°M' }, 'XFIN': { i: 'ðŸ’°', name: 'FÄ°NANS' }, 'XAKUR': { i: 'ðŸ’¼', name: 'ARACI KURUM' }, 'XSIGORTA': { i: 'ðŸ›¡ï¸', name: 'SÄ°GORTA' }, 'XTRZM': { i: 'ðŸ¨', name: 'TURÄ°ZM' }, 'XUSIN': { i: 'ðŸ­', name: 'SINAÄ°' }, 'XUHARZ': { i: 'ðŸ†•', name: 'HALKA ARZ' }, 'XSGRT': { i: 'ðŸ›¡ï¸', name: 'SÄ°GORTA' }, 'XMESY': { i: 'âš™ï¸', name: 'METAL EÅžYA' }, 'XHOLD': { i: 'ðŸ¤', name: 'HOLDÄ°NG' }, 'XUSRD': { i: 'ðŸŒ±', name: 'SÃœRDÃœRÃœLEBÄ°LÄ°RLÄ°K' }, 'XINSA': { i: 'ðŸ—ï¸', name: 'Ä°NÅžAAT' } };

        function initApp() {
            try {
                if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
                auth = firebase.auth();
                db = firebase.firestore();
            } catch (error) { console.log(error); }

            auth.onAuthStateChanged(async (u) => {
                user = u;
                window.updateAuthUI(u);
                
                if (Object.keys(window.LIVE_STOCKS).length === 0) await fetchSheetData();
                checkMarketStatus(); 
                
                if (user && !user.isAnonymous) {
                    const userDocRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                    const userDoc = await userDocRef.get();
                    let friendCode;
                    if (userDoc.exists && userDoc.data().friendCode) {
                        friendCode = userDoc.data().friendCode;
                        appState.name = userDoc.data().teamName || "SEN"; 
                    } else {
                        friendCode = "#U-" + Math.floor(1000 + Math.random() * 9000);
                        await userDocRef.set({
                            friendCode: friendCode,
                            teamName: appState.name,
                            email: user.email
                        }, { merge: true });
                    }
                    document.getElementById('user-friend-code').innerText = friendCode;
                    document.getElementById('scoreboard-team-name').innerText = appState.name;
                    await loadUserSquad();
                    loadUserWatchlist(); // Favorileri yÃ¼kle
                    loadFriendsList(); 
                } else {
                    document.getElementById('user-friend-code').innerText = "#GIRIS-YAP";
                }

                renderMiniStandings(45);
                renderHistory();
            });
            
            if(pool.court[0] === null) renderPool();
            window.GAME_STATE.currentQuest = QUESTS[Math.floor(Math.random() * QUESTS.length)];
            const qText = document.getElementById('president-quest-text');
            if (qText) qText.innerText = window.GAME_STATE.currentQuest.text;
            setInterval(checkMarketStatus, 60000); 
        }

        // --- FAVORÄ° SÄ°STEMÄ° FONKSÄ°YONLARI (ARRAY TABANLI) ---
        window.switchMarketTab = function(tab) {
            window.GAME_STATE.activeTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
            document.getElementById(tab === 'all' ? 'tab-all' : 'tab-fav').classList.add('active-tab');
            renderMarket();
        }

        let saveTimeout = null;
        window.toggleFav = function(symbol) {
            const list = window.GAME_STATE.watchlist;
            const index = list.indexOf(symbol);
            
            if (index > -1) {
                list.splice(index, 1);
                window.showToast(`${symbol} havuzdan Ã§Ä±karÄ±ldÄ±.`, "bg-slate-600");
            } else {
                list.push(symbol);
                window.showToast(`${symbol} havuza eklendi.`, "bg-pink-600");
            }
            renderMarket(); 
            
            // 4 Saniye Debounce
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                if (user && !user.isAnonymous) {
                    try {
                        await db.collection('artifacts').doc(appId)
                            .collection('users').doc(user.uid)
                            .set({ watchlist: window.GAME_STATE.watchlist }, { merge: true });
                    } catch(e) { console.error("Fav save error", e); }
                }
            }, 4000);
        }

        async function loadUserWatchlist() {
            if (!user) return;
            try {
                const doc = await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).get();
                if (doc.exists && doc.data().watchlist) {
                    window.GAME_STATE.watchlist = doc.data().watchlist || [];
                    renderMarket(); 
                }
            } catch (e) { console.log(e); }
        }

        // --- SÃœRÃœKLE BIRAK SIRALAMA (HAVUZ Ä°Ã‡Ä°N) ---
        window.handleListDrop = function(e, targetSymbol) {
            e.preventDefault();
            if(window.GAME_STATE.activeTab !== 'fav') return;
            
            const dragData = JSON.parse(e.dataTransfer.getData('text'));
            // Sadece market iÃ§inden sÃ¼rÃ¼kleniyorsa ve zaten listedeyse sÄ±ralama yap
            if (dragData.from === 'market' && window.GAME_STATE.watchlist.includes(dragData.s)) {
                const list = window.GAME_STATE.watchlist;
                const fromIndex = list.indexOf(dragData.s);
                const toIndex = list.indexOf(targetSymbol);
                
                if (fromIndex > -1 && toIndex > -1) {
                    // Dizide yer deÄŸiÅŸtir (Araya ekle)
                    list.splice(fromIndex, 1);
                    list.splice(toIndex, 0, dragData.s);
                    renderMarket();
                    
                    // VeritabanÄ±na kaydet (Debounce ile)
                    if (saveTimeout) clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(async () => {
                        if (user && !user.isAnonymous) {
                            await db.collection('artifacts').doc(appId)
                                .collection('users').doc(user.uid)
                                .set({ watchlist: window.GAME_STATE.watchlist }, { merge: true });
                        }
                    }, 4000);
                }
            }
        }

        // --- HESAPLAMA VE OYUN MANTIÄžI ---
        function calculatePlayerScore(playerKey, location) {
            const stock = window.LIVE_STOCKS[playerKey];
            if (!stock) return { score: 0, raw: 0, bonus: 0 };
            
            let rawPerf = parseFloat(stock.perf.val); 
            const traitCount = stock.badges.length;
            const badgeBonus = traitCount * 0.40;
            let adjustedScore = rawPerf + badgeBonus;
            
            let roleMultiplier = 1.0;
            if (window.GAME_STATE.captain === playerKey) roleMultiplier = 1.50; 
            else if (window.GAME_STATE.viceCaptain === playerKey) roleMultiplier = 1.25; 
            else if (window.GAME_STATE.loanPlayer === playerKey) roleMultiplier = 1.10; 
            
            let locationMultiplier = (location === 'bench') ? 0.5 : 1.0;
            let finalPlayerScore = adjustedScore * roleMultiplier * locationMultiplier;
            
            return { score: finalPlayerScore, raw: rawPerf, adjusted: adjustedScore };
        }

        function calculateTeamTotalScore(bistChange) {
            let totalScore = 0;
            let startingFiveScore = 0; 
            let uniqueSectors = new Set();
            
            [...pool.court, ...pool.bench].forEach((p, idx) => {
                if(p) {
                    const loc = idx < 5 ? 'court' : 'bench';
                    const pStats = calculatePlayerScore(p, loc);
                    totalScore += pStats.score;
                    if (loc === 'court') {
                        const stock = window.LIVE_STOCKS[p];
                        if (stock) {
                            uniqueSectors.add(stock.sector_code);
                            startingFiveScore += pStats.adjusted; 
                        }
                    }
                }
            });

            if (uniqueSectors.size > 0 && uniqueSectors.size <= 2) {
                if (bistChange > 0) totalScore += (totalScore * 0.05); 
                else totalScore -= Math.abs(totalScore * 0.10); 
            } else if (uniqueSectors.size >= 5) {
                totalScore += 2.0; 
            }

            let tacticMultiplier = 1.0;
            const tactic = window.GAME_STATE.tactic;

            if (tactic === 'atak') {
                const target = 2.0;
                const userPassed = (startingFiveScore > 2.0);
                const marketPassed = (bistChange > target);
                if (marketPassed && userPassed) tacticMultiplier += 0.25; 
                else if (!marketPassed && userPassed) tacticMultiplier -= 0.10; 
                else if (!marketPassed && !userPassed) tacticMultiplier -= 0.20; 
            } else if (tactic === 'defans') {
                const target = -1.0;
                if (bistChange < target) {
                    if (totalScore < 0) totalScore = 0; 
                    else totalScore += (totalScore * 0.50); 
                } else {
                    tacticMultiplier -= 0.25; 
                }
            }
            totalScore *= tacticMultiplier;
            if (window.GAME_STATE.bonusUsed) totalScore *= 1.5;
            return totalScore.toFixed(2);
        }

        window.simulateMatch = function() {
            SIMULATED_BIST_CHANGE = (Math.random() * 7 - 3).toFixed(2);
            const userScore = calculateTeamTotalScore(parseFloat(SIMULATED_BIST_CHANGE));
            const opponentScore = (parseFloat(SIMULATED_BIST_CHANGE) * 1.2).toFixed(2); 
            document.getElementById('score-val-user').innerText = userScore;
            document.getElementById('score-val-opponent').innerText = opponentScore;
            let msgColor = parseFloat(SIMULATED_BIST_CHANGE) > 0 ? "text-green-400" : "text-red-400";
            document.getElementById('match-status').innerHTML = `BIST: <span class="${msgColor}">%${SIMULATED_BIST_CHANGE}</span>`;
            window.showToast(`SimÃ¼lasyon TamamlandÄ±! Puan: ${userScore}`, "bg-blue-600");
        }

        function checkMarketStatus() {
            const now = new Date(); 
            const day = now.getDay(); const hour = now.getHours(); const min = now.getMinutes();
            let isOpen = false;
            // Cuma 18:30 sonrasÄ±, Cumartesi, Pazar, Pazartesi 09:30 Ã¶ncesi
            if (day === 5 && (hour > 18 || (hour === 18 && min >= 30))) isOpen = true; 
            else if (day === 6 || day === 0) isOpen = true; 
            else if (day === 1 && (hour < 9 || (hour === 9 && min < 30))) isOpen = true; 
            isOpen = true; // TEST Ä°Ã‡Ä°N SÃœREKLÄ° AÃ‡IK (Mola modu)

            window.GAME_STATE.marketOpen = isOpen;
            
            const statusEl = document.getElementById('match-status');
            const subTitle = document.querySelector('.brand-subtitle');
            const saveBtn = document.getElementById('save-btn');
            const resetBtn = document.getElementById('reset-btn');
            
            if (isOpen) {
                statusEl.innerText = "MOLA (TRANSFER AÃ‡IK)";
                statusEl.className = "mola-indicator";
                
                let targetMonday = new Date(now);
                if (day === 1 && (hour < 9 || (hour === 9 && min < 30))) { } 
                else { let daysUntilMonday = (1 + 7 - day) % 7; if(daysUntilMonday === 0) daysUntilMonday = 7; targetMonday.setDate(now.getDate() + daysUntilMonday); }
                
                const mMonth = targetMonday.getMonth(); const mDate = targetMonday.getDate();
                const monthNames = ["OCAK","ÅžUBAT","MART","NÄ°SAN","MAYIS","HAZÄ°RAN","TEMMUZ","AÄžUSTOS","EYLÃœL","EKÄ°M","KASIM","ARALIK"];
                let limit = 1; let infoText = "NORMAL HAFTA";
                let seasonText = "CANLI PÄ°YASA"; 
                
                if (mDate <= 7) {
                    if (mMonth === 11 || mMonth === 2 || mMonth === 5 || mMonth === 8) {
                        limit = 5; 
                        let seasonName = "";
                        if(mMonth===11) seasonName = "KIÅž LÄ°GÄ°"; if(mMonth===2) seasonName = "Ä°LKBAHAR LÄ°GÄ°"; if(mMonth===5) seasonName = "YAZ LÄ°GÄ°"; if(mMonth===8) seasonName = "SONBAHAR LÄ°GÄ°";
                        infoText = `${seasonName} AÃ‡ILIÅžI`;
                        seasonText = seasonName; 
                    } else {
                        infoText = `${monthNames[mMonth]} KUPASI AÃ‡ILIÅžI`;
                        limit = 3;
                        seasonText = `${monthNames[mMonth]} KUPASI`; 
                    }
                } else {
                    infoText = "NORMAL HAFTA";
                }
                
                if(subTitle) {
                    subTitle.innerText = seasonText; 
                    subTitle.style.color = "#22c55e";
                }
                window.GAME_STATE.transferLimit = limit;
                document.getElementById('gameweek-info').innerText = infoText;
                saveBtn.disabled = false; saveBtn.classList.remove('opacity-50', 'cursor-not-allowed'); resetBtn.disabled = false;

            } else {
                statusEl.innerText = "OYNANIYOR (TRANSFER KAPALI)"; statusEl.className = "live-indicator"; 
                if(subTitle) {
                    subTitle.innerText = "PÄ°YASA KAPALI";
                    subTitle.style.color = "#ef4444"; 
                }
                saveBtn.disabled = true; saveBtn.classList.add('opacity-50', 'cursor-not-allowed'); resetBtn.disabled = true; 
                document.getElementById('gameweek-info').innerText = "";
            }
            updateTransferInfoUI();
        }

        async function loadUserSquad() { 
             try {
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('squads').doc('current');
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    const data = docSnap.data();
                    if(data.squad) {
                        pool = data.squad;
                        window.GAME_STATE.captain = data.captain;
                        window.GAME_STATE.viceCaptain = data.viceCaptain;
                        window.GAME_STATE.tactic = data.tactic;
                        window.GAME_STATE.loanPlayer = data.loanPlayer || null;
                        if (data.bonusUsed) { window.GAME_STATE.bonusUsed = true; document.querySelector('.btn-prim').classList.add('btn-prim-active'); }
                        window.GAME_STATE.initialSquad = [...pool.court, ...pool.bench]; 
                        renderPool();
                    }
                }
             } catch (e) { console.log("Kadro hatasÄ±", e); }
        }

        window.resetSquad = function() {
            if(!window.GAME_STATE.marketOpen) return;
            if (window.GAME_STATE.initialSquad.length === 0) {
                pool = { court: [null,null,null,null,null], bench: [null,null,null,null,null] };
                window.GAME_STATE.loanPlayer = null; window.GAME_STATE.captain = null; window.GAME_STATE.viceCaptain = null;
            } else {
                const init = window.GAME_STATE.initialSquad;
                pool = { court: init.slice(0, 5), bench: init.slice(5, 10) };
                window.GAME_STATE.loanPlayer = null; 
            }
            renderAll(); window.showToast("Kadro SÄ±fÄ±rlandÄ±", "bg-yellow-600");
        }

        async function fetchSheetData() {
            if(isFetching) return;
            
            // --- CACHE KONTROLÃœ (10 Dakika) ---
            const cachedData = localStorage.getItem('bbl_stock_data');
            const cacheTime = localStorage.getItem('bbl_data_time');
            const now = new Date().getTime();

            if (cachedData && cacheTime && (now - cacheTime < 10 * 60 * 1000)) {
                console.log("Veriler Ã¶nbellekten (Cache) okunuyor...");
                processStockData(JSON.parse(cachedData));
                return;
            }

            isFetching = true;
            try {
                const colRef = db.collection(COLLECTION_NAME); 
                const snapshot = await colRef.get();
                const rawData = [];
                snapshot.forEach((doc) => { let d = doc.data(); d.sembol = doc.id; rawData.push(d); });
                
                if (rawData.length > 0) { 
                    // Veriyi kaydet (Cache)
                    localStorage.setItem('bbl_stock_data', JSON.stringify(rawData));
                    localStorage.setItem('bbl_data_time', now);
                    processStockData(rawData); 
                } 
                else {
                      // HÄ°SSE Ä°SÄ°MLERÄ° GELMEZSE BURADAKÄ° MOCK DATA Ã‡ALIÅžACAK
                      const mockData = [ 
                        { sembol: 'THYAO', hakkinda: 'TÃœRK HAVA YOLLARI A.O.', pazar: 'YILDIZ', endeks: 'BIST 30', fk: 4.5, pddd: 0.8, fdfavok: 6.2, sektor: 'XULAS', temettu_bilgi: 'TEMETTÃœ', transfer_degeri: 20.5 }, 
                        { sembol: 'EREGL', hakkinda: 'EREÄžLÄ° DEMÄ°R Ã‡ELÄ°K', pazar: 'YILDIZ', endeks: 'BIST 30', fk: 8.2, pddd: 1.1, fdfavok: 5.4, sektor: 'XMANA', temettu_bilgi: 'TEMETTÃœ25', transfer_degeri: -5.0 },
                        { sembol: 'GARAN', hakkinda: 'GARANTÄ° BANKASI', pazar: 'YILDIZ', endeks: 'BIST 30', fk: 3.5, pddd: 0.9, fdfavok: 0, sektor: 'XBANK', temettu_bilgi: '', transfer_degeri: 15.0 },
                        { sembol: 'ASELS', hakkinda: 'ASELSAN ELEKTRONÄ°K', pazar: 'YILDIZ', endeks: 'BIST 30', fk: 12.5, pddd: 3.2, fdfavok: 10.0, sektor: 'XUTEK', temettu_bilgi: 'TEMETTÃœ', transfer_degeri: 25.0 }
                      ];
                      processStockData(mockData);
                }
            } catch (error) { console.log(error); } finally { isFetching = false; }
        }

        function calculateMedians(stocks) {
            const sectors = {}; 
            Object.values(stocks).forEach(stock => {
                let code = stock.sector_code || "DIGER";
                if (!sectors[code]) sectors[code] = { fk: [], pd: [], favok: [], name: stock.sector_info.name };
                if (stock.raw_fk) sectors[code].fk.push(stock.raw_fk); if (stock.raw_pd) sectors[code].pd.push(stock.raw_pd); if (stock.raw_favok) sectors[code].favok.push(stock.raw_favok);
            });
            const medians = {};
            for (const code in sectors) { medians[code] = { fk: getMedian(sectors[code].fk), pd: getMedian(sectors[code].pd), favok: getMedian(sectors[code].favok), name: sectors[code].name + " ORT." }; }
            return medians;
        }
        function getMedian(values) { if (!values || values.length === 0) return 0; values.sort((a, b) => a - b); const half = Math.floor(values.length / 2); return values.length % 2 ? values[half] : (values[half - 1] + values[half]) / 2.0; }

        function processStockData(dataList) {
            window.LIVE_STOCKS = {}; window.SECTOR_LIST.clear();
            dataList.forEach(item => {
                let stockName = item.sembol; if (!stockName) return; 
                let market = item[DATA_MAP.COL_MARKET] ? item[DATA_MAP.COL_MARKET].toString().toUpperCase() : "";
                
                let dbPrice = parseFloat(item[DATA_MAP.COL_TRANSFER]);
                let rawCost = (!isNaN(dbPrice)) ? parseFloat(dbPrice.toFixed(1)) : Math.floor(Math.random() * 50) + 1;
                
                let finalCost = rawCost;
                let costBreakdown = ""; 

                if (rawCost < 0) {
                    let base = Math.abs(rawCost) + 5;
                    finalCost = base * 1.5;
                    costBreakdown = "Transferde Zorluk Ã‡Ä±karÄ±yor (+%50 Tazminat)";
                } else if (rawCost >= 0 && rawCost <= 10) {
                    finalCost = rawCost + 5;
                    costBreakdown = `${rawCost}+5 Tazminat (Serbest Kalma Maddesi)`;
                } else {
                    costBreakdown = "Piyasa DeÄŸeri";
                }
                finalCost = parseFloat(finalCost.toFixed(1));

                let contractInfo = getContractInfo(market);
                let index = item[DATA_MAP.COL_INDEX] || ""; let fame = getFameLevel(index);
                let secCodeRaw = item[DATA_MAP.COL_SECTOR]; let secInfo = getSectorInfo(secCodeRaw);
                window.SECTOR_LIST.add(secInfo.name);

                let perf = (Math.random() * 10 - 5).toFixed(2); 
                let perfClass = perf >= 0 ? "perf-pos" : "perf-neg"; let perfSign = perf >= 0 ? "+" : "";

                // --- YETENEK KARTLARI (BADGES) - GÃœNCELLENDÄ° (AÃ§Ä±klamalÄ±) ---
                let badges = [];
                if (item.potansiyel && parseFloat(item.potansiyel) > 0.2) badges.push({i:'ðŸŒŸ', t:'Potansiyel (Analist Hedef)', c:'sk-guc', id:'pot'});
                if (item.zeka && parseFloat(item.zeka) < -2.0) badges.push({i:'ðŸ§ ', t:'Zeka (Beneish GÃ¼venilir)', c:'sk-tek', id:'zek'});
                if (item.defans && parseFloat(item.defans) > 4.0) badges.push({i:'ðŸ›¡ï¸', t:'Defans (Altman Z-Score)', c:'sk-def', id:'def'});
                if (item.asist && parseFloat(item.asist) > 0.19) badges.push({i:'ðŸ¤', t:'Asist (TemettÃ¼ Verimi)', c:'sk-sut', id:'asist'});
                if (item.sut && parseFloat(item.sut) > 0.2) badges.push({i:'ðŸ”¥', t:'Åžut (Ã–zkaynak KÃ¢rlÄ±lÄ±ÄŸÄ±)', c:'sk-sut', id:'sut'});
                if (item.hiz && parseFloat(item.hiz) > 0.4) badges.push({i:'â©', t:'HÄ±z (FAVÃ–K BÃ¼yÃ¼mesi)', c:'sk-hiz', id:'hiz'});
                if (item.guc && parseFloat(item.guc) > 0.2) badges.push({i:'ðŸ’ª', t:'GÃ¼Ã§ (Net KÃ¢r MarjÄ±)', c:'sk-guc', id:'guc'});
                if (item.teknik && parseFloat(item.teknik) > 0.0) badges.push({i:'âš™ï¸', t:'Teknik (Ar-Ge/YatÄ±rÄ±m)', c:'sk-tek', id:'tek'});

                window.LIVE_STOCKS[stockName] = {
                    fullName: item[DATA_MAP.COL_FULL_NAME] || stockName, // Tam Ä°sim Eklendi
                    cost: finalCost, rawCost: rawCost, costBreakdown: costBreakdown,
                    overall: Math.floor(Math.random()*40)+50, perf: { val: perf, class: perfClass, sign: perfSign },
                    type: contractInfo.type, badgeClass: contractInfo.badgeClass, shoulderText: contractInfo.shoulderText,
                    fame: fame, indexRaw: index, marketRaw: market,
                    isTemettu: String(item[DATA_MAP.COL_DIVIDEND_INFO]).includes("TEMETTÃœ"), isTemettu25: String(item[DATA_MAP.COL_DIVIDEND_INFO]).includes("25"),
                    isKatilim: String(item[DATA_MAP.COL_PARTICIPATION]).includes("KATILIM"), isKatilim100: String(item[DATA_MAP.COL_PARTICIPATION]).includes("100"),
                    isGeriAlim: String(item[DATA_MAP.COL_BUYBACK]).includes("GERÄ°"), isKurumsal: String(item[DATA_MAP.COL_CORP]).includes("KURUMSAL"),
                    isHalkaArz: String(item[DATA_MAP.COL_IPO]).includes("XHARZ"), isSurdurulebilir: String(item[DATA_MAP.COL_SURDUR]).includes("SÃœRDÃœR"),
                    fk: formatValue(parseFloat(item[DATA_MAP.COL_FK])), pd: formatValue(parseFloat(item[DATA_MAP.COL_PD_DD])), favok: formatValue(parseFloat(item[DATA_MAP.COL_FD_FAVOK])),
                    raw_fk: parseFloat(item[DATA_MAP.COL_FK]), raw_pd: parseFloat(item[DATA_MAP.COL_PD_DD]), raw_favok: parseFloat(item[DATA_MAP.COL_FD_FAVOK]),
                    cond: Math.floor(Math.random() * 30) + 70, sector_code: secCodeRaw, sector_info: secInfo,
                    traits: generateTraits(index, item[DATA_MAP.COL_DIVIDEND_INFO], item[DATA_MAP.COL_PARTICIPATION], item[DATA_MAP.COL_BUYBACK], item[DATA_MAP.COL_CORP], item[DATA_MAP.COL_IPO], item[DATA_MAP.COL_SURDUR], secInfo),
                    badges: badges 
                };
            });
            window.SECTOR_STATS = calculateMedians(window.LIVE_STOCKS);
            window.FILTERED_STOCKS = {...window.LIVE_STOCKS}; 
            populateSectorFilter(); 
            window.renderAll();
        }

        // KISA KOD GÃ–STERÄ°LÄ°R, TOOLTIPTE UZUN AÃ‡IKLAMA YAZAR
        function getContractInfo(market) { 
            let type = "YARI"; let badgeClass = "c-yari"; let shoulderText = "YARI"; 
            if (market.includes("YILDIZ")) { type = "ELÄ°T"; badgeClass = "c-elit"; shoulderText = "ELIT"; } 
            else if (market.includes("ANA")) { type = "STND"; badgeClass = "c-std"; shoulderText = "STND"; } 
            return { type, badgeClass, shoulderText }; 
        }
        
        function getFameLevel(index) { 
            const iStr = (index || "").toString().toUpperCase(); 
            if (iStr.includes("30") || iStr.includes("030")) return { text: "KÄ±talararasÄ± Ãœn (BIST 30)", icon: "ðŸŒ" }; 
            if (iStr.includes("50") && !iStr.includes("500")) return { text: "KÄ±tasal Ãœn (BIST 50)", icon: "ðŸ‡ªðŸ‡º" }; 
            if (iStr.includes("100")) return { text: "Ulusal Ãœn (BIST 100)", icon: "ðŸ‡¹ðŸ‡·" }; 
            if (iStr.includes("500")) return { text: "BÃ¶lgesel Ãœn (BIST 500)", icon: "ðŸ™ï¸" }; 
            return { text: "TanÄ±nmÄ±yor", icon: "â“" }; 
        }
        function getSectorInfo(code) { return (code && SECTOR_MAP[code]) ? SECTOR_MAP[code] : { i: 'ðŸ­', name: code || 'GENEL' }; }
        
        // TOOLTIP GÃœNCELLEMESÄ° (PARANTEZ Ä°Ã‡Ä° KODLAR EKLENDÄ°)
        function generateTraits(index, divInfo, part, buyback, corp, ipo, surdur, secInfo) { 
            let t = [{i: secInfo.i, text: `${secInfo.name} (${Object.keys(SECTOR_MAP).find(k => SECTOR_MAP[k].name === secInfo.name) || '-'})`}]; 
            if(String(divInfo).includes("25")) t.push({i: "ðŸŽ", text: "TemettÃ¼ 25 (XTM25)"}); else if(String(divInfo).includes("TEMETTÃœ")) t.push({i: "ðŸ§§", text: "TemettÃ¼ Veren (XTMTU)"}); 
            if(String(part).includes("100")) t.push({i: "ðŸ•Œ", text: "KatÄ±lÄ±m 100 (XK100)"}); else if(String(part).includes("KATILIM")) t.push({i: "ðŸ“¿", text: "KatÄ±lÄ±m (XKTUM)"}); 
            if(String(buyback).includes("GERÄ°")) t.push({i: "ðŸ”„", text: "Geri AlÄ±m (XUGRA)"}); 
            if(String(corp).includes("KURUMSAL")) t.push({i: "âš–ï¸", text: "Kurumsal (XKURY)"}); 
            if(String(ipo).includes("XHARZ")) t.push({i: "ðŸ†•", text: "Halka Arz (XHARZ)"}); 
            if(String(surdur).includes("SÃœRDÃœR")) t.push({i: "ðŸŒ±", text: "SÃ¼rdÃ¼rÃ¼lebilirlik (XUSRD)"}); 
            return t; 
        }
        function formatValue(val) { if (val === undefined || val === null || isNaN(val)) return "-"; let absVal = Math.abs(val); if (absVal >= 100) return Math.round(val); if (absVal >= 10) return val.toFixed(1); return val.toFixed(2); }

        window.applyDetailedFilters = function() {
            const sector = document.getElementById('filter-sector')?.value;
            const contract = document.getElementById('filter-contract')?.value;
            const fame = document.getElementById('filter-fame')?.value;
            const checks = {
                temettu: document.getElementById('chk-temettu').checked, temettu25: document.getElementById('chk-temettu25').checked,
                katilim: document.getElementById('chk-katilim').checked, katilim100: document.getElementById('chk-katilim100').checked,
                geri: document.getElementById('chk-gerialim').checked, kurum: document.getElementById('chk-kurumsal').checked,
                arz: document.getElementById('chk-halkaarz').checked, surdur: document.getElementById('chk-surdurulebilir').checked,
                ucuzFK: document.getElementById('chk-ucuz-fk').checked, ucuzPD: document.getElementById('chk-ucuz-pd').checked, ucuzFD: document.getElementById('chk-ucuz-fd').checked,
                skPot: document.getElementById('chk-skill-pot').checked, skZek: document.getElementById('chk-skill-zek').checked,
                skDef: document.getElementById('chk-skill-def').checked, skAsist: document.getElementById('chk-skill-asist').checked,
                skSut: document.getElementById('chk-skill-sut').checked, skHiz: document.getElementById('chk-skill-hiz').checked,
                skGuc: document.getElementById('chk-skill-guc').checked, skTek: document.getElementById('chk-skill-tek').checked
            };
            window.ACTIVE_FILTERS = { sector, contract, fame, ...checks };
            document.getElementById('btn-scout').classList.add('active-filter');
            closeModal('scout-modal');
            const searchInput = document.getElementById('search-input');
            searchInput.placeholder = "Filtre AÃ§Ä±k - Hisse Ara...";
            searchInput.classList.add('filtered');
            renderMarket(); 
        }

        window.resetFilters = function() {
            window.ACTIVE_FILTERS = null;
            document.getElementById('btn-scout').classList.remove('active-filter');
            document.querySelectorAll('#scout-modal input[type="checkbox"]').forEach(c => c.checked = false);
            document.querySelectorAll('#scout-modal select').forEach(s => s.selectedIndex = 0);
            const searchInput = document.getElementById('search-input');
            searchInput.placeholder = "Hisse Ara...";
            searchInput.classList.remove('filtered');
            renderMarket();
        }
        
        function renderMarket() {
            const container = document.getElementById('market-list');
            if (!container) return;
            const searchTerm = document.getElementById('search-input')?.value.toUpperCase() || "";
            container.innerHTML = '';
            
            let results = Object.keys(window.LIVE_STOCKS);

            // 1. SEKME FÄ°LTRESÄ° (ARRAY SIRASI KORUNACAK)
            if (window.GAME_STATE.activeTab === 'fav') {
                // Havuzdaysa array sÄ±rasÄ±na gÃ¶re render et
                const watchListArray = window.GAME_STATE.watchlist;
                if (watchListArray.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-500 mt-10 text-xs p-4">HenÃ¼z havuza oyuncu eklemedin.<br>TÃ¼m Piyasa sekmesinden <i class="fas fa-heart text-slate-600"></i> ikonuna basarak ekleyebilirsin.</div>';
                    return;
                }
                results = watchListArray.filter(key => window.LIVE_STOCKS[key]); // Sadece verisi olanlarÄ± al
            }

            // 2. SCOUT FÄ°LTRESÄ°
            if (window.ACTIVE_FILTERS) {
                const f = window.ACTIVE_FILTERS;
                results = results.filter(key => {
                    const s = window.LIVE_STOCKS[key];
                    if(!s) return false;
                    const secStats = window.SECTOR_STATS[s.sector_code];
                    let pass = true;
                    if (f.sector !== 'all' && s.sector_info.name !== f.sector) pass = false;
                    if (f.contract !== 'all' && s.type !== f.contract) pass = false;
                    if (f.fame !== 'all') {
                        if (f.fame === '30' && !s.indexRaw.includes('30')) pass = false;
                        if (f.fame === '50' && !s.indexRaw.includes('50')) pass = false;
                        if (f.fame === '100' && !s.indexRaw.includes('100')) pass = false;
                    }
                    if (f.temettu && !s.isTemettu) pass = false;
                    if (f.temettu25 && !s.isTemettu25) pass = false;
                    if (f.katilim && !s.isKatilim) pass = false;
                    if (f.katilim100 && !s.isKatilim100) pass = false;
                    if (f.geri && !s.isGeriAlim) pass = false;
                    if (f.kurum && !s.isKurumsal) pass = false;
                    if (f.arz && !s.isHalkaArz) pass = false;
                    if (f.surdur && !s.isSurdurulebilir) pass = false;
                    if (secStats) {
                        if (f.ucuzFK && !(s.raw_fk > 0 && s.raw_fk < 16 && s.raw_fk < secStats.fk * 0.75)) pass = false;
                        if (f.ucuzPD && !(s.raw_pd > 0 && s.raw_pd < 3 && s.raw_pd < secStats.pd * 0.75)) pass = false;
                        if (f.ucuzFD && !(s.raw_favok > 0 && s.raw_favok < 20 && s.raw_favok < secStats.favok * 0.75)) pass = false;
                    }
                    const checkBadge = (id) => s.badges.some(b => b.id === id);
                    if (f.skPot && !checkBadge('pot')) pass = false;
                    if (f.skZek && !checkBadge('zek')) pass = false;
                    if (f.skDef && !checkBadge('def')) pass = false;
                    if (f.skAsist && !checkBadge('asist')) pass = false;
                    if (f.skSut && !checkBadge('sut')) pass = false;
                    if (f.skHiz && !checkBadge('hiz')) pass = false;
                    if (f.skGuc && !checkBadge('guc')) pass = false;
                    if (f.skTek && !checkBadge('tek')) pass = false;
                    return pass;
                });
            }

            if (searchTerm) { results = results.filter(key => key.includes(searchTerm)); }
            
            if (results.length === 0 && window.GAME_STATE.activeTab === 'all') { 
                container.innerHTML = '<div class="text-center text-slate-500 mt-10 text-xs">SonuÃ§ bulunamadÄ±.</div>'; return; 
            }

            results.forEach(key => {
                const data = window.LIVE_STOCKS[key];
                const used = pool.court.includes(key) || pool.bench.includes(key);
                const sectorStats = window.SECTOR_STATS[data.sector_code] || { fk:0, pd:0, favok:0, name: "GENEL ORT." };
                
                const isFav = window.GAME_STATE.watchlist.includes(key);
                const favClass = isFav ? "fas fa-heart is-fav" : "far fa-heart";

                const div = document.createElement('div');
                div.className = `market-item ${used ? 'used' : ''}`;
                div.draggable = !used;
                
                // Tooltip (Hover Bilgisi - Åžirket Tam Ä°smi)
                div.title = data.fullName;

                const isNewUser = (window.GAME_STATE.initialSquad.length === 0);
                if(!window.GAME_STATE.marketOpen && !isNewUser) div.draggable = false;

                // Drag Events
                div.ondragstart = (e) => { 
                    e.dataTransfer.setData('text', JSON.stringify({s:key, from:'market'})); 
                    div.classList.add('dragging');
                    const dragImage = document.createElement('div'); dragImage.className = 'player-card'; dragImage.style.width = '100px'; dragImage.style.position = 'absolute'; dragImage.style.top = '-999px';
                    dragImage.innerHTML = `<div class="jersey ${appState.pattern}"><div class="jersey-sponsor-area"><i class="fas ${appState.icon} text-2xl opacity-50" style="color:${appState.logoColor}"></i></div><div class="jersey-bottom"><div class="jersey-name">${key}</div></div></div>`;
                    document.body.appendChild(dragImage); e.dataTransfer.setDragImage(dragImage, 50, 50); setTimeout(() => document.body.removeChild(dragImage), 100);
                };
                div.ondragend = () => div.classList.remove('dragging');
                
                // Havuzda SÄ±ralama Ä°Ã§in Drop Zone
                if (window.GAME_STATE.activeTab === 'fav') {
                    div.ondragover = (e) => e.preventDefault();
                    div.ondrop = (e) => window.handleListDrop(e, key);
                }

                let badgesHtml = data.badges.map(b => `<div class="skill-icon-mini ${b.c}" title="${b.t}">${b.i}</div>`).join('');
                let gemFK = (data.raw_fk > 0 && data.raw_fk < 16 && sectorStats.fk > 0 && data.raw_fk < sectorStats.fk * 0.75) ? '<i class="fas fa-gem text-blue-400 diamond-icon" title="SektÃ¶re GÃ¶re Ucuz"></i>' : '';
                let gemPD = (data.raw_pd > 0 && data.raw_pd < 3 && sectorStats.pd > 0 && data.raw_pd < sectorStats.pd * 0.75) ? '<i class="fas fa-gem text-blue-400 diamond-icon" title="SektÃ¶re GÃ¶re Ucuz"></i>' : '';
                let gemFD = (data.raw_favok > 0 && data.raw_favok < 20 && sectorStats.favok > 0 && data.raw_favok < sectorStats.favok * 0.75) ? '<i class="fas fa-gem text-blue-400 diamond-icon" title="SektÃ¶re GÃ¶re Ucuz"></i>' : '';

                // HTML GÃœNCELLEMESÄ° (Logo eklendi)
                div.innerHTML = `
                    <div class="cond-strip"><div class="cond-fill ${data.cond > 70 ? 'cond-high' : (data.cond > 40 ? 'cond-med' : 'cond-low')}" style="height: ${data.cond}%"></div></div>
                    
                    <i class="fav-btn ${favClass}" onclick="event.stopPropagation(); toggleFav('${key}')"></i>

                    <div class="m-row-1">
                        <div class="market-logo-container">
                            <img src="assets/logos/${key}.svg" class="market-logo-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                            <div class="market-logo-fallback" style="display:none">${key.substring(0,2)}</div>
                        </div>

                        <div class="m-name-group">
                            <span class="m-name">${key}</span>
                            <span class="contract-badge ${data.badgeClass}" title="${data.shoulderText}">${data.type}</span>
                            <span class="fame-icon" title="${data.fame.text}">${data.fame.icon}</span>
                            ${data.traits.map(t => `<span class="trait-mini" title="${t.text}">${t.i}</span>`).join('')}
                        </div>
                        <div class="m-cost-box" data-breakdown="${data.costBreakdown}"><span class="m-price">${data.cost}M</span></div>
                    </div>
                    <div class="m-row-2">
                        <div class="m-traits-wrapper">${badgesHtml}</div>
                        <div class="m-basic-stats"><span>FK:<span class="hl-val">${data.fk}</span></span><span>PD:<span class="hl-val">${data.pd}</span></span><span>FD:<span class="hl-val">${data.favok}</span></span></div>
                    </div>
                    <div class="m-expanded">
                        <table class="comparison-table">
                            <tr><th class="text-left text-slate-400">ORAN</th><th class="text-right text-blue-400">HÄ°SSE</th><th class="text-right text-slate-400">GENEL ORT.</th></tr>
                            <tr><td class="text-slate-300">F/K</td><td class="text-right font-mono font-bold text-white">${data.fk}${gemFK}</td><td class="text-right font-mono text-slate-400">${formatValue(sectorStats.fk)}</td></tr>
                            <tr><td class="text-slate-300">PD/DD</td><td class="text-right font-mono font-bold text-white">${data.pd}${gemPD}</td><td class="text-right font-mono text-slate-400">${formatValue(sectorStats.pd)}</td></tr>
                            <tr><td class="text-slate-300">FD/FAVÃ–K</td><td class="text-right font-mono font-bold text-white">${data.favok}${gemFD}</td><td class="text-right font-mono text-slate-400">${formatValue(sectorStats.favok)}</td></tr>
                        </table>
                        <div class="mt-2 pt-2 border-t border-slate-700">
                             <div class="text-[9px] text-slate-400 font-bold mb-1">PERFORMANS (CANLI)</div>
                             <div class="perf-table-row"><span>GÃœN</span><span class="perf-val-neutral" id="perf-d-${key}">-</span></div>
                             <div class="perf-table-row"><span>HAFTA</span><span class="perf-val-neutral" id="perf-w-${key}">-</span></div>
                             <div class="perf-table-row"><span>AY</span><span class="perf-val-neutral" id="perf-m-${key}">-</span></div>
                             <div class="perf-table-row"><span>3 AY</span><span class="perf-val-neutral" id="perf-3m-${key}">-</span></div>
                             <div class="perf-table-row"><span>YIL</span><span class="perf-val-neutral" id="perf-y-${key}">-</span></div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        window.openLeagueModal = function(type) { 
            const list = document.getElementById('list-col-1'); 
            if(list && list.innerHTML === "") renderFullLeague();
            window.openModal('league-modal'); 
        }
        
        function renderFullLeague() {
            const createRow = (rank, name, score, isMe) => `<div class="full-row ${isMe ? 'me' : ''}"><span>${rank}. ${name}</span><span>${score}P</span></div>`;
            const cols = [document.getElementById('list-col-1'), document.getElementById('list-col-2'), document.getElementById('list-col-3'), document.getElementById('list-col-4')];
            let rank = 1;
            cols.forEach((col, idx) => {
                if(!col) return;
                col.innerHTML = "";
                for(let i=0; i<25; i++) {
                    let isMe = (rank === 45); 
                    let name = isMe ? appState.name : `TakÄ±m ${rank}`;
                    let score = 1200 - (rank * 10) + Math.floor(Math.random()*20);
                    col.innerHTML += createRow(rank, name, score, isMe);
                    rank++;
                }
            });
        }
        
        window.renderMiniStandings = function(userRank) {
            const tLeague = document.getElementById('mini-table-league');
            const tCup = document.getElementById('mini-table-cup');
            if(tLeague) tLeague.innerHTML = `
                <tr class="standings-row"><td><span class="text-green-400">â–²</span></td><td class="rank-cell">1</td><td>Lider Basket</td><td class="points-cell">1240</td></tr>
                <tr class="standings-row"><td><span class="text-slate-500">-</span></td><td class="rank-cell">2</td><td>BoÄŸa Spor</td><td class="points-cell">1215</td></tr>
                <tr class="standings-row user-highlight"><td><span class="text-green-400">â–²</span></td><td class="rank-cell">45</td><td>${appState.name}</td><td class="points-cell">850</td></tr>
            `;
            if(tCup) tCup.innerHTML = `
                <tr class="standings-row"><td><span class="text-green-400">â–²</span></td><td class="rank-cell">1</td><td>Efes Pilsen</td><td class="points-cell">210</td></tr>
                <tr class="standings-row user-highlight"><td><span class="text-slate-500">-</span></td><td class="rank-cell">12</td><td>${appState.name}</td><td class="points-cell">145</td></tr>
            `;
        }

        // --- TAKVÄ°M YARDIMCISI (PAZARTESÄ° ODAKLI) ---
        function getWeeksInMonth(year, month) {
            let weeks = [];
            let d = new Date(year, month, 1);
            while (d.getDay() !== 1) { d.setDate(d.getDate() + 1); }
            while (d.getMonth() === month) {
                let monday = new Date(d);
                let friday = new Date(d); friday.setDate(monday.getDate() + 4);
                weeks.push({ monday: monday, friday: friday });
                d.setDate(d.getDate() + 7);
            }
            return weeks;
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            if(!container) return;

            const seasons = [
                { name: "2025 KIÅž LÄ°GÄ°", months: [11, 0, 1], year: 2025 },
                { name: "2025 Ä°LKBAHAR LÄ°GÄ°", months: [2, 3, 4], year: 2025 },
                { name: "2025 YAZ LÄ°GÄ°", months: [5, 6, 7], year: 2025 },
                { name: "2025 SONBAHAR LÄ°GÄ°", months: [8, 9, 10], year: 2025 }
            ];

            const monthNames = ["OCAK","ÅžUBAT","MART","NÄ°SAN","MAYIS","HAZÄ°RAN","TEMMUZ","AÄžUSTOS","EYLÃœL","EKÄ°M","KASIM","ARALIK"];
            
            const getRankHTML = (rank) => {
                let badgeClass = "rank-mid"; let icon = "";
                if (!rank) return '<span class="text-slate-600 text-[9px]">-</span>';
                if (rank <= 25) badgeClass = "rank-green"; else if (rank >= 76) badgeClass = "rank-red";
                if (rank === 1) icon = "ðŸ¥‡"; else if (rank === 2) icon = "ðŸ¥ˆ"; else if (rank === 3) icon = "ðŸ¥‰"; else icon = "#" + rank;
                return `<span class="history-rank-badge ${badgeClass}">${icon}</span>`;
            };

            let html = `<div class="history-wrapper">`;

            [...seasons].reverse().forEach(season => {
                html += `<div class="history-season-col">
                            <div class="history-season-header">
                                <div>${season.name}</div>
                                <div class="mt-1 text-[9px] font-normal opacity-70">GENEL SIRALAMA</div>
                            </div>`;
                
                season.months.forEach(mIndex => {
                    let currentYear = season.year;
                    if (season.name.includes("KIÅž") && mIndex === 11) currentYear = season.year - 1;
                    const weeks = getWeeksInMonth(currentYear, mIndex);
                    
                    html += `<div class="history-month-block">
                                <div class="history-month-header">
                                    <span>${monthNames[mIndex]} KUPASI</span>
                                    ${getRankHTML(Math.floor(Math.random()*100)+1)}
                                </div>
                                <div>`;
                    
                    weeks.forEach((week, idx) => {
                        const dateStr = week.friday.toLocaleDateString('tr-TR', { day: 'numeric', month: 'numeric' });
                        const isFuture = week.friday > new Date();
                        const points = isFuture ? "--" : Math.floor(Math.random() * 50 + 80);
                        const scoreClass = isFuture ? "text-slate-600 italic" : "history-score";
                        
                        html += `<div class="history-week-row">
                                    <span class="text-[9px] text-slate-400 w-16">${idx+1}. Hafta (${dateStr})</span>
                                    <span class="${scoreClass}">${points}</span>
                                 </div>`;
                    });

                    if(weeks.length === 0) { html += `<div class="text-[8px] text-slate-600 p-2 text-center">Bu ay maÃ§ haftasÄ± yok.</div>`; }
                    html += `   </div></div>`;
                });
                html += `</div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        window.openFriendsModal = function() { window.openModal('friends-modal'); }
        window.openFriendSquad = function(name) { window.openModal('squad-view-modal'); }
        window.renderAll = function() { renderMarket(); renderPool(); };
        window.updateAuthUI = function(u) { const btn = document.getElementById('auth-btn'); if(btn) { if (u && !u.isAnonymous) { btn.innerText = "Ã‡IKIÅž YAP"; btn.onclick = window.logout; } else { btn.innerText = "GÄ°RÄ°Åž"; btn.onclick = window.login; }}};
        window.login = async () => { try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch (e) {} };
        window.logout = async () => { await auth.signOut(); window.location.reload(); };
        
        window.save = async () => { 
            const initial = window.GAME_STATE.initialSquad || [];
            if (initial.length === 0) {
                const totalPlayers = [...pool.court, ...pool.bench].filter(x => x).length;
                if (totalPlayers < 8) { window.showToast("Kadronuzda en az 8 oyuncu olmalÄ±!", "bg-red-600"); return; }
                if (user && !user.isAnonymous) window.saveSquadToFirebase({ court: pool.court, bench: pool.bench }); else window.showToast("GiriÅŸ YapmalÄ±sÄ±nÄ±z", "bg-yellow-600"); return;
            }
            if(!window.GAME_STATE.marketOpen) { window.showToast("Transfer dÃ¶nemi kapalÄ±!", "bg-red-600"); return; }
            const initialSet = new Set(initial.filter(x => x));
            let usedTransfers = 0;
            [...pool.court, ...pool.bench].forEach(p => { if(p && !initialSet.has(p) && p !== window.GAME_STATE.loanPlayer) { usedTransfers++; } });
            const loanUsed = window.GAME_STATE.loanPlayer ? 1 : 0;
            if (usedTransfers > window.GAME_STATE.transferLimit) { window.showToast(`Transfer Limitini AÅŸtÄ±nÄ±z!`, "bg-red-600"); return; }
            if (loanUsed > window.GAME_STATE.loanLimit) { window.showToast("KiralÄ±k Limitini AÅŸtÄ±nÄ±z!", "bg-red-600"); return; }
            let totalCost = 0; [...pool.court, ...pool.bench].forEach(k => { if(k && k !== window.GAME_STATE.loanPlayer) { totalCost += (window.LIVE_STOCKS[k]?.cost || 0); } });
            if (totalCost > MAX_BUDGET) { window.showToast(`BÃ¼tÃ§e SÄ±nÄ±rÄ±nÄ± (${MAX_BUDGET}M) AÅŸtÄ±nÄ±z!`, "bg-red-600"); return; }
            const totalPlayers = [...pool.court, ...pool.bench].filter(x => x).length;
            if (totalPlayers < 8) { window.showToast("Kadronuzda en az 8 oyuncu olmalÄ±!", "bg-red-600"); return; }
            if (user && !user.isAnonymous) window.saveSquadToFirebase({ court: pool.court, bench: pool.bench }); else window.showToast("GiriÅŸ YapmalÄ±sÄ±nÄ±z", "bg-yellow-600"); 
        };

        window.saveSquadToFirebase = async (squadData) => {
            try {
                if (!user) { window.showToast("GiriÅŸ yapmalÄ±sÄ±n!", "bg-red-600"); return; }
                const squadRef = db.collection('artifacts').doc(appId)
                                   .collection('users').doc(user.uid)
                                   .collection('squads').doc('current');
                const saveData = {
                    squad: squadData,
                    captain: window.GAME_STATE.captain,
                    viceCaptain: window.GAME_STATE.viceCaptain,
                    loanPlayer: window.GAME_STATE.loanPlayer,
                    tactic: window.GAME_STATE.tactic,
                    bonusUsed: window.GAME_STATE.bonusUsed,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };
                await squadRef.set(saveData, { merge: true });
                window.showToast("Kadro ve Taktikler Kaydedildi!", "bg-green-600");
                window.GAME_STATE.initialSquad = [...pool.court, ...pool.bench];
                updateTransferInfoUI();
            } catch (error) {
                console.error("KayÄ±t hatasÄ±:", error);
                window.showToast("Kaydederken hata oluÅŸtu!", "bg-red-600");
            }
        };
        
        window.openModal = (id) => document.getElementById(id).style.display = "flex";
        window.closeModal = (id) => document.getElementById(id).style.display = "none";
        
        window.showToast = function(msg, bg) { 
            const t = document.getElementById('toast'); 
            if(t) { 
                t.innerText = msg; 
                t.className = `toast show ${bg}`; 
                setTimeout(() => t.className="toast", 3000); 
            } 
        };

        window.showTooltip = function(el, title, text) { 
            const tt = document.getElementById('global-tooltip'); 
            if(!tt) {
                const n=document.createElement('div'); n.id='global-tooltip'; n.className='coach-tooltip'; document.body.appendChild(n);
            } 
            const tEl = document.getElementById('global-tooltip'); 
            tEl.innerHTML = `<strong>${title}</strong>${text}`; 
            tEl.style.opacity = '1'; 
            const rect = el.getBoundingClientRect(); 
            tEl.style.left = (rect.left + rect.width / 2) + 'px'; 
            tEl.style.bottom = (window.innerHeight - rect.top + 10) + 'px'; 
        };
        
        window.hideTooltip = function() { 
            const t=document.getElementById('global-tooltip'); 
            if(t) t.style.opacity = '0'; 
        };

        window.openCaptainSelector = function(role) {
            const list = document.getElementById('captain-list');
            list.innerHTML = '';
            const squad = [...pool.court, ...pool.bench].filter(p => p); 
            if(squad.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-500 py-4 font-bold text-xs">Ã–nce kadrona oyuncu ekle!</div>';
            } else {
                squad.forEach(player => {
                    const row = document.createElement('div');
                    row.className = 'flex justify-between items-center p-2 border-b border-slate-700 hover:bg-slate-800 cursor-pointer';
                    row.onclick = () => window.setCaptain(player, role);
                    row.innerHTML = `<div class="flex items-center gap-2"><img src="https://ui-avatars.com/api/?name=${player}&background=random&color=fff" class="w-8 h-8 rounded-full"><span class="text-sm font-bold text-white">${player}</span></div><button class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-xs text-white">SEÃ‡</button>`;
                    list.appendChild(row);
                });
            }
            document.getElementById('cap-modal-title').innerText = role === 'C' ? "KAPTAN SEÃ‡" : "YRD. KAPTAN SEÃ‡";
            window.openModal('captain-modal');
        };

        window.setCaptain = function(key, role) { 
            if (role === 'C') { window.GAME_STATE.captain = key; if(window.GAME_STATE.viceCaptain === key) window.GAME_STATE.viceCaptain = null; } 
            if (role === 'VC') { window.GAME_STATE.viceCaptain = key; if(window.GAME_STATE.captain === key) window.GAME_STATE.captain = null; } 
            renderPool(); window.closeModal('captain-modal'); 
        };
        
        window.openLoanSelector = function() {
            const list = document.getElementById('loan-list');
            list.innerHTML = '';
            const squad = [...pool.court, ...pool.bench].filter(p => p);
            const initialSet = new Set(window.GAME_STATE.initialSquad);
            const isNewUser = window.GAME_STATE.initialSquad.length === 0;
            const eligiblePlayers = squad.filter(p => { if (isNewUser) return true; return !initialSet.has(p); });
            if (eligiblePlayers.length === 0) {
                list.innerHTML = `<div class="text-center text-slate-500 py-4"><div class="text-yellow-500 font-bold mb-2">KiralÄ±k AdayÄ± Yok</div><div class="text-[10px]">Sadece bu hafta transfer edilen oyuncular<br>bedelsiz (kiralÄ±k) oynatÄ±labilir.</div></div>`;
            } else {
                eligiblePlayers.forEach(player => {
                    const row = document.createElement('div');
                    row.className = 'flex justify-between items-center p-2 border-b border-slate-700 hover:bg-slate-800 cursor-pointer';
                    row.onclick = () => window.setLoanPlayer(player);
                    row.innerHTML = `<div class="flex items-center gap-2"><img src="https://ui-avatars.com/api/?name=${player}&background=random&color=fff" class="w-8 h-8 rounded-full"><span class="text-sm font-bold text-white">${player}</span></div><button class="bg-purple-600 hover:bg-purple-500 px-3 py-1 rounded text-xs text-white font-bold">SEÃ‡ (+%10)</button>`;
                    list.appendChild(row);
                });
            }
            window.openModal('loan-modal');
        };

        window.setLoanPlayer = function(key) { window.GAME_STATE.loanPlayer = key; renderPool(); window.closeModal('loan-modal'); };
        window.setTactic = function(t) { window.GAME_STATE.tactic = t; document.querySelectorAll('.icon-only-btn').forEach(b => b.classList.remove('active')); if(t==='atak') document.querySelector('.btn-atk').classList.add('active'); if(t==='defans') document.querySelector('.btn-def').classList.add('active'); if(t==='dengeli') document.querySelector('.btn-bal').classList.add('active'); window.showToast("Taktik: " + t.toUpperCase(), "bg-blue-600"); };
        
        window.toggleBonus = function() {
            if(window.GAME_STATE.bonusUsed) {
                window.GAME_STATE.bonusUsed = false; document.querySelector('.btn-prim').classList.remove('btn-prim-active'); updateBudget(); window.showToast("Prim Ä°ptal Edildi.", "bg-slate-600");
            } else {
                let currentSpent = 0; [...pool.court, ...pool.bench].forEach(k => { if(k && k !== window.GAME_STATE.loanPlayer) { currentSpent += (window.LIVE_STOCKS[k]?.cost || 0); } });
                if (currentSpent > 130) { window.showToast("Harcaman 130M Ã¼zerinde! Prim veremezsin.", "bg-red-600"); return; }
                if(confirm("DÄ°KKAT: Prim hakkÄ± ayda sadece 1 kez kullanÄ±lÄ±r.\n\nBÃ¼tÃ§ene +10M sanal harcama eklenir ve bu haftaki borsa performansÄ±n %50 artar.\n\nOnaylÄ±yor musun?")) { 
                    window.GAME_STATE.bonusUsed = true; document.querySelector('.btn-prim').classList.add('btn-prim-active'); updateBudget(); window.showToast("ðŸ’° PRÄ°M AKTÄ°F!", "bg-yellow-600"); 
                }
            }
        };

        window.updateTransferInfoUI = function() {
            const initial = window.GAME_STATE.initialSquad || [];
            if (initial.length === 0) return;
            const initialSet = new Set(initial.filter(x => x));
            let usedTransfers = 0;
            [...pool.court, ...pool.bench].forEach(p => { if(p && !initialSet.has(p) && p !== window.GAME_STATE.loanPlayer) { usedTransfers++; } });
            const loanUsed = window.GAME_STATE.loanPlayer ? 1 : 0;
            const tBadge = document.getElementById('transfer-count-badge');
            const lBadge = document.getElementById('loan-count-badge');
            if(tBadge) {
                tBadge.innerText = `Transfer: ${usedTransfers}/${window.GAME_STATE.transferLimit}`;
                if(usedTransfers > window.GAME_STATE.transferLimit) { tBadge.classList.add('warning'); tBadge.classList.remove('success'); }
                else { tBadge.classList.remove('warning'); tBadge.classList.add('success'); }
            }
            if(lBadge) {
                lBadge.innerText = `KiralÄ±k: ${loanUsed}/${window.GAME_STATE.loanLimit}`;
                if(loanUsed > window.GAME_STATE.loanLimit) { lBadge.classList.add('warning'); lBadge.classList.remove('success'); }
                else { lBadge.classList.remove('warning'); lBadge.classList.add('success'); }
            }
        };

        window.updateBudget = function() {
            let total = 0;
            [...pool.court, ...pool.bench].forEach(k => { 
                if(k) {
                   if (k === window.GAME_STATE.loanPlayer) { total += 5; } 
                   else { total += (window.LIVE_STOCKS[k]?.cost || 0); }
                }
            });
            if(window.GAME_STATE.bonusUsed) total += 10;
            total = parseFloat(total.toFixed(1));
            
            const bBar = document.getElementById('budget-bar');
            const bText = document.getElementById('budget-text');
            if(bBar && bText) {
                const pct = Math.min((total / MAX_BUDGET) * 100, 100);
                bBar.style.width = pct + '%';
                bText.innerText = `${total}M / ${MAX_BUDGET}M`;
                if(total > MAX_BUDGET) bBar.classList.add('budget-warning'); else bBar.classList.remove('budget-warning');
            }
        }
        
        window.populateSectorFilter = function() { const sel = document.getElementById('filter-sector'); if(sel) { sel.innerHTML = '<option value="all">TÃ¼m SektÃ¶rler</option>'; Array.from(window.SECTOR_LIST).sort().forEach(s => { let opt = document.createElement('option'); opt.value = s; opt.innerText = s; sel.appendChild(opt); }); } };
        window.renderPalettes = function() { const createPalette = (id, targetProp) => { const el = document.getElementById(id); if(!el) return; el.innerHTML = ''; PRESET_COLORS.forEach(c => { const d = document.createElement('div'); d.className = 'w-5 h-5 rounded cursor-pointer border border-white/20'; if(tempState[targetProp] === c) d.classList.add('ring-2', 'ring-white'); d.style.backgroundColor = c; d.onclick = () => { tempState[targetProp] = c; renderPalettes(); updateModalPreview(); }; el.appendChild(d); }); el.className = 'flex gap-1 flex-wrap'; }; createPalette('palette-primary', 'primary'); createPalette('palette-secondary', 'secondary'); createPalette('palette-logo', 'logoColor'); }
        window.openSettings = function() { tempState = { ...appState }; document.getElementById('team-name-input').value = tempState.name; document.getElementById('jersey-pattern').value = tempState.pattern; document.getElementById('text-bg-check').checked = tempState.textBg; document.querySelectorAll('.logo-option').forEach(opt => opt.classList.remove('selected')); document.querySelectorAll('.logo-option i').forEach(i => { if(i.classList.contains(tempState.icon)) i.parentElement.classList.add('selected'); }); renderPalettes(); updateModalPreview(); document.getElementById('settings-modal').style.display = "flex"; }
        window.closeSettings = function() { document.getElementById('settings-modal').style.display = "none"; }
        window.updateModalPreview = function() { tempState.name = document.getElementById('team-name-input').value || "SEN"; tempState.pattern = document.getElementById('jersey-pattern').value; tempState.textBg = document.getElementById('text-bg-check').checked; const pJersey = document.getElementById('preview-jersey'); const pName = document.getElementById('preview-name'); const pIcon = document.getElementById('preview-icon'); pName.innerText = tempState.name; pJersey.className = `jersey ${tempState.pattern}`; if(tempState.textBg) pName.classList.add('has-bg'); else pName.classList.remove('has-bg'); pJersey.style.setProperty('--jersey-primary', tempState.primary); pJersey.style.setProperty('--jersey-secondary', tempState.secondary); pIcon.className = `fas ${tempState.icon} opacity-50 text-2xl`; pIcon.style.color = tempState.logoColor; }
        window.selectLogoPreview = function(el, iconClass) { document.querySelectorAll('.logo-option').forEach(opt => opt.classList.remove('selected')); el.classList.add('selected'); tempState.icon = iconClass; updateModalPreview(); }
        window.saveSettings = function() { appState = { ...tempState }; document.documentElement.style.setProperty('--jersey-primary', appState.primary); document.documentElement.style.setProperty('--jersey-secondary', appState.secondary); document.documentElement.style.setProperty('--logo-color', appState.logoColor); document.getElementById('scoreboard-team-name').innerText = appState.name.toUpperCase(); const navIcon = document.querySelector('#nav-team-logo i'); navIcon.className = `fas ${appState.icon} text-white`; navIcon.style.color = appState.logoColor; window.renderAll(); window.showToast("âœ… Ayarlar Kaydedildi!", "bg-green-600"); closeSettings(); window.renderMiniStandings(); }

        function renderPool() {
            const court = document.getElementById('court-drop-zone'); if(!court) return;
            document.querySelectorAll('.slot-container').forEach(e => e.remove());
            
            // Tooltip iÃ§eriÄŸi (Sadece YEDEK kulÃ¼besi iÃ§in kullanÄ±lacak)
            const rulesTooltip = `
            <div class="transfer-tooltip" style="width:220px; bottom: 100%; top: auto; margin-bottom: 10px;">
                <strong class="text-yellow-500 border-b border-white/10 pb-1 block mb-1">PUAN & KÄ°MYA</strong>
                <ul class="text-[10px] text-slate-300">
                    <li><span class="text-blue-400">Ä°lk 5:</span> %100 Puan</li>
                    <li><span class="text-slate-400">Yedek:</span> %50 Puan</li>
                    <li><span class="text-yellow-400">Kaptan:</span> x1.5 Puan</li>
                    <li><span class="text-green-400">SektÃ¶r Bonusu:</span> Ä°lk 5 oyuncun 5 farklÄ± sektÃ¶rden ise <span class="text-green-400">+2 Puan</span>.</li>
                </ul>
            </div>`;
            
            const pos = [{t:'82%', l:'35%', label:'PG'}, {t:'82%', l:'65%', label:'SG'}, {t:'45%', l:'12%', label:'SF'}, {t:'45%', l:'88%', label:'PF'}, {t:'34%', l:'50%', label:'C'}];
            
            pool.court.forEach((s, i) => {
                const el = document.createElement('div'); el.className = 'slot-container group'; el.style.top = pos[i].t; el.style.left = pos[i].l;
                el.setAttribute('ondragover', 'event.preventDefault()'); el.setAttribute('ondrop', `window.handleDrop(event, ${i}, 'court')`);
                // GÃœNCELLEME: else kÄ±smÄ±ndan ${rulesTooltip} kaldÄ±rÄ±ldÄ±. ArtÄ±k sahada boÅŸken ipucu Ã§Ä±kmayacak.
                if (s) { el.innerHTML = createCard(s, i, 'court'); } else { el.innerHTML = `<div class="empty-slot-circle relative">${pos[i].label}</div>`; }
                court.appendChild(el);
            });

            const bench = document.getElementById('bench-container');
            if(bench) {
                bench.innerHTML = pool.bench.map((s, i) => {
                    // Yedek kulÃ¼besinde tooltip kalmaya devam ediyor
                    if (s) { return `<div class="bench-seat" ondragover="event.preventDefault()" ondrop="window.handleDrop(event, ${i}, 'bench')">${createCard(s, i, 'bench')}</div>`; } 
                    else { return `<div class="bench-seat relative group overflow-visible" ondragover="event.preventDefault()" ondrop="window.handleDrop(event, ${i}, 'bench')"><img src="assets/koltuklogo.png" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'" class="w-3/4 h-3/4 object-contain opacity-30 group-hover:opacity-50 transition pointer-events-none absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"><span class="text-xs text-slate-400 opacity-30 font-bold hidden items-center justify-center w-full h-full">BOÅž</span>${rulesTooltip}</div>`; }
                }).join('');
            }
            updateBudget(); 
            const cBtn = document.getElementById('btn-cap'); const vcBtn = document.getElementById('btn-vc');
            cBtn.innerHTML = `<i class="fas fa-copyright text-yellow-500"></i>`; if (window.GAME_STATE.captain) { cBtn.innerHTML += `<div class="cap-badge">${window.GAME_STATE.captain}</div>`; }
            vcBtn.innerHTML = `<i class="fas fa-star-half-alt text-gray-400"></i>`; if (window.GAME_STATE.viceCaptain) { vcBtn.innerHTML += `<div class="cap-badge">${window.GAME_STATE.viceCaptain}</div>`; }
        }

        function createCard(key, idx, type) {
            const d = window.LIVE_STOCKS[key] || {cost:0, type:'?', shoulderText:'', badges:[], perf:{val:0, class:'', sign:''}};
            const isLoan = (key === window.GAME_STATE.loanPlayer);
            const isViewOnly = (type === 'view-only'); // ArkadaÅŸ kadrosu iÃ§in
            
            let cBadge = ""; if(window.GAME_STATE.captain === key) cBadge = `<div class="armband band-c">C</div>`; else if(window.GAME_STATE.viceCaptain === key) cBadge = `<div class="armband band-vc">VC</div>`;
            let sbClass = "sb-yari"; if(d.type === "ELÄ°T") sbClass = "sb-elit"; else if(d.type === "STND") sbClass = "sb-std";
            let tooltipText = ""; if (d.badges && d.badges.length > 0) { tooltipText = d.badges.map(b => `${b.i} ${b.t}`).join('\n'); } else { tooltipText = "Ekstra Ã¶zellik yok"; }
            let traitsHtml = ""; if(d.traits && d.traits.length > 0) traitsHtml = `<div class="traits-container">` + d.traits.map(t => `<div class="trait-icon-card" title="${t.text}">${t.i}</div>`).join('') + `</div>`;
            let nameClass = "jersey-name"; if(appState.textBg) nameClass += " has-bg";
            
            // View-only ise draggable'Ä± kapat ve X butonunu kaldÄ±r
            const dragAttr = isViewOnly ? '' : 'draggable="true"';
            const removeBtn = isViewOnly ? '' : `<div class="cost-badge" onclick="window.remove('${type}', ${idx}); event.stopPropagation()"><span class="val-text">${isLoan ? 'K' : d.cost}</span><span class="remove-icon"><i class="fas fa-times"></i></span></div>`;
            
            // SHOULDER BADGE TEXT -> SADECE KISA KOD Ã‡IKACAK
            return `<div class="player-card" ${dragAttr} ondragstart="event.dataTransfer.setData('text', JSON.stringify({s:'${key}', from:'${type}', idx:${idx}}))"><div class="player-perf-badge ${d.perf.class}">${d.perf.sign}${d.perf.val}%</div>${removeBtn}${isLoan ? '<div class="loan-icon">K</div>' : ''}${cBadge}<div class="shoulder-badge ${sbClass}" data-traits="${tooltipText}">${d.shoulderText}</div><div class="jersey ${appState.pattern}"><div class="jersey-sponsor-area"><i class="fas ${appState.icon} text-2xl opacity-50" style="color:${appState.logoColor}"></i></div><div class="jersey-bottom">${traitsHtml}<div class="${nameClass}">${key}</div></div></div><img src="https://ui-avatars.com/api/?name=${key}&background=fff&color=000&font-size=0.4" class="player-head"></div>`;
        }

        window.handleDrop = function(e, idx, to) { e.preventDefault(); const isNewUser = (window.GAME_STATE.initialSquad.length === 0); if(!window.GAME_STATE.marketOpen && !isNewUser) { window.showToast("Transfer KapalÄ±!", "bg-red-600"); return; } const data = JSON.parse(e.dataTransfer.getData('text')); if(data.from === 'market') { if(to === 'court') pool.court[idx] = data.s; else pool.bench[idx] = data.s; } else { const temp = to === 'court' ? pool.court[idx] : pool.bench[idx]; if(to === 'court') pool.court[idx] = data.s; else pool.bench[idx] = data.s; if(data.from === 'court') pool.court[data.idx] = temp; else pool.bench[data.idx] = temp; } renderAll(); }
        window.remove = function(from, idx) { const isNewUser = (window.GAME_STATE.initialSquad.length === 0); if(!window.GAME_STATE.marketOpen && !isNewUser) return; const removedPlayer = from === 'court' ? pool.court[idx] : pool.bench[idx]; if(removedPlayer === window.GAME_STATE.loanPlayer) window.GAME_STATE.loanPlayer = null; if(removedPlayer === window.GAME_STATE.captain) window.GAME_STATE.captain = null; if(removedPlayer === window.GAME_STATE.viceCaptain) window.GAME_STATE.viceCaptain = null; if(from === 'court') pool.court[idx] = null; else pool.bench[idx] = null; renderAll(); }

        // --- YENÄ° ARKADAÅž SÄ°STEMÄ° ---
        window.addFriend = async function() {
            if (!user || user.isAnonymous) { window.showToast("Ã–nce giriÅŸ yapmalÄ±sÄ±n!", "bg-red-600"); return; }
            const searchInput = document.querySelector('#friends-modal input');
            const code = searchInput.value.trim();
            if (!code.startsWith("#U-") || code.length !== 7) { window.showToast("HatalÄ± kod formatÄ±! (#U-xxxx)", "bg-red-600"); return; }
            if (code === document.getElementById('user-friend-code').innerText) { window.showToast("Kendini ekleyemezsin.", "bg-yellow-600"); return; }

            try {
                const usersRef = db.collection('artifacts').doc(appId).collection('users');
                const snapshot = await usersRef.where('friendCode', '==', code).get();
                if (snapshot.empty) { window.showToast("KullanÄ±cÄ± bulunamadÄ±.", "bg-red-600"); return; }

                let friendId = ""; let friendData = {};
                snapshot.forEach(doc => { friendId = doc.id; friendData = doc.data(); });

                await usersRef.doc(user.uid).collection('friends').doc(friendId).set({
                    name: friendData.teamName || "Rakip TakÄ±m",
                    code: friendData.friendCode,
                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                window.showToast("ArkadaÅŸ Eklendi!", "bg-green-600");
                searchInput.value = "";
            } catch (error) { console.error("Hata:", error); window.showToast("Hata oluÅŸtu.", "bg-red-600"); }
        }

        window.loadFriendsList = function() {
            if (!user || user.isAnonymous) return;
            const listContainer = document.querySelector('#friends-modal .flex-col');
            listContainer.innerHTML = '<div class="text-xs text-slate-500 text-center">YÃ¼kleniyor...</div>';
            
            db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('friends')
            .onSnapshot((snapshot) => {
                listContainer.innerHTML = '';
                if (snapshot.empty) { listContainer.innerHTML = '<div class="text-xs text-slate-500 text-center mt-4">HenÃ¼z arkadaÅŸÄ±n yok.</div>'; return; }
                
                snapshot.forEach(doc => {
                    const f = doc.data(); const friendId = doc.id;
                    const div = document.createElement('div');
                    div.className = 'friend-row';
                    div.onclick = () => window.openFriendSquad(friendId, f.name);
                    div.innerHTML = `<div class="friend-info"><span class="friend-name">${f.name}</span><span class="friend-status">${f.code}</span></div><button class="text-xs text-red-400 hover:text-red-200" onclick="event.stopPropagation(); window.removeFriend('${friendId}')"><i class="fas fa-trash"></i></button>`;
                    listContainer.appendChild(div);
                });
            });
        }

        window.removeFriend = async function(friendId) {
            if(confirm("Silmek istiyor musun?")) {
                await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('friends').doc(friendId).delete();
                window.showToast("Silindi.", "bg-slate-600");
            }
        }

        window.openFriendSquad = async function(friendId, friendName) {
            window.openModal('squad-view-modal');
            document.getElementById('friend-squad-title').innerText = (friendName || "ARKADAÅž") + " KADROSU";
            const container = document.getElementById('friend-squad-list');
            container.innerHTML = '<div class="text-white text-xs">YÃ¼kleniyor...</div>';

            try {
                const docRef = db.collection('artifacts').doc(appId).collection('users').doc(friendId).collection('squads').doc('current');
                const docSnap = await docRef.get();
                
                if (!docSnap.exists) { container.innerHTML = '<div class="text-slate-500 text-xs">Bu arkadaÅŸ henÃ¼z kadro kurmamÄ±ÅŸ.</div>'; return; }

                const data = docSnap.data();
                const court = data.squad.court || [];
                
                container.innerHTML = '';
                let hasPlayers = false;
                court.forEach(playerKey => {
                    if(playerKey) {
                        hasPlayers = true;
                        const wrapper = document.createElement('div');
                        wrapper.innerHTML = createCard(playerKey, 0, 'view-only');
                        wrapper.className = "transform scale-90"; 
                        container.appendChild(wrapper);
                    }
                });
                
                if(!hasPlayers) container.innerHTML = '<div class="text-slate-500 text-xs">Ä°lk 5 boÅŸ.</div>';

            } catch (error) { console.error(error); container.innerHTML = '<div class="text-red-500 text-xs">Hata oluÅŸtu.</div>'; }
        }

        if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', initApp); } else { initApp(); }
    </script>
</body>
</html>